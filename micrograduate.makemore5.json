{"version":3,"kind":"Notebook","sha256":"10cc35aed28ce253f4849cd83b2710de172d81ae0479bdcbda690be595c94a1d","slug":"micrograduate.makemore5","location":"/micrograduate/makemore5.ipynb","dependencies":[],"frontmatter":{"title":"6. makemore (part 5): building a WaveNet","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"micrograduate-env","language":"python"},"github":"https://github.com/ckaraneen/micrograduate","copyright":"MIT License","source_url":"https://github.com/ckaraneen/micrograduate/blob/main/micrograduate/makemore5.ipynb","edit_url":"https://github.com/ckaraneen/micrograduate/edit/main/micrograduate/makemore5.ipynb","exports":[{"format":"ipynb","filename":"makemore5.ipynb","url":"/build/makemore5-d1cf81979511fbc29491020f1d099ee9.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import sys\n\nIN_COLAB = \"google.colab\" in sys.modules\nif IN_COLAB:\n    print(\"Cloning repo...\")\n    !git clone --quiet https://github.com/ckaraneen/micrograduate.git > /dev/null\n    %cd micrograduate\n    print(\"Installing requirements...\")\n    !pip install --quiet uv\n    !uv pip install --system --quiet -r requirements.txt","key":"INFYpNU4j4"},{"type":"outputs","id":"5qbjzthR3GP-H0OKEKc49","children":[],"key":"h8P5vAcDPQ"}],"key":"MktRWjhyNp"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Intro","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sKpUkLYYyg"}],"identifier":"intro","label":"Intro","html_id":"intro","implicit":true,"key":"eQ42jpE8eU"}],"visibility":"show","key":"PB2GsiGxSq"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Hi, everyone! Today we are continuing our implementation of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yczTcsTvhZ"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"makemore","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LRWuUSkoI6"}],"key":"xKkKe6wqzg"},{"type":"text","value":", our favorite character-level language model. Now, over the last few lectures, we’ve built up an architecture that is a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"c6VWo0vpDM"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"mlp","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qDujql0Nbu"}],"key":"lnwuO2x3Eu"},{"type":"text","value":" character-level language model. So we see that it receives ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YtPyoVG5pT"},{"type":"text","value":"3","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Mq7hsoOAuC"},{"type":"text","value":" previous characters and tries to predict the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BWeCidqYfo"},{"type":"inlineMath","value":"4th","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mi>t</mi><mi>h</mi></mrow><annotation encoding=\"application/x-tex\">4th</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord\">4</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span></span></span></span>","key":"UrrTArLHUf"},{"type":"text","value":" character in a sequence using one hidden layer of neurons with ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rneXSk1K6A"},{"type":"inlineCode","value":"tanh","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BfxmQuGyoA"},{"type":"text","value":" nonlinearities:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bxvUkXt7ki"}],"key":"gxHrr0XuaC"}],"key":"s8vHoI7GuL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from IPython.display import Image, display\n\ndisplay(Image(filename=\"bengio2003nn.jpeg\"))","key":"ZYPXUwfwYy"},{"type":"outputs","id":"QnEEJ8PQakrrl8w9p4UQG","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/jpeg":{"content_type":"image/jpeg","hash":"a21abcc7498c74c85d4a3cd5f51b3817","path":"/build/a21abcc7498c74c85d4a3cd5f51b3817.jpeg"},"text/plain":{"content":"<IPython.core.display.Image object>","content_type":"text/plain"}}},"children":[],"key":"VRa1qUcR24"}],"key":"tmGd335dJm"}],"key":"Pwyn9c61O8"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"So what we’d like to do now in this lecture is to complexify this architecture. In particular, we would like to take more characters in a sequence as an input, not just ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"EXyf8qa6H4"},{"type":"text","value":"3","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vKl2fJnXfO"},{"type":"text","value":". In addition to that, we don’t just want to feed them all into a single hidden layer, because that squashes too much information too quickly. Instead, we would like to make a deeper model that progressively fuses this information to make its guess about the next character in a sequence. We’re actually going to arrive at something that looks very much like ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Af26raUQrM"},{"type":"link","url":"https://arxiv.org/abs/1609.03499","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"WaveNet","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WLrKsQ2BD2"}],"key":"cs77DIjaeZ"},{"type":"text","value":", a paper published by DeepMind in 2016","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xWcQ4EAgSM"}],"urlSource":"https://arxiv.org/abs/1609.03499","key":"lQg49D4q4O"},{"type":"text","value":". Which is a language model basically, but it tries to predict audio sequences instead of character-level sequences or word-level sequences:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sjmlrEHvBy"}],"key":"jyiv7KPOuy"}],"key":"OvfSdUj0A3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from IPython.display import Image, display\n\ndisplay(Image(filename=\"wavenet_fig1.png\"))","key":"Iczvp3wFRn"},{"type":"outputs","id":"O7gJlaHp-FKLf729UqpUE","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"3f9530b394e99dfd6655c51628e3e70c","path":"/build/3f9530b394e99dfd6655c51628e3e70c.png"},"text/plain":{"content":"<IPython.core.display.Image object>","content_type":"text/plain"}}},"children":[],"key":"WpZmdfdPpk"}],"key":"be0f1S7H2Y"}],"key":"pXnwFIy89d"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"But fundamentally, the modeling setup is identical. It is an autoregressive model and it tries to predict the next character in a sequence:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HGgvfOvhOg"}],"key":"sORVLCGvtr"}],"key":"H74EH1q5Tw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from IPython.display import Image, display\n\ndisplay(Image(filename=\"wavenet_eq1.png\"))","key":"MKxc09HGWw"},{"type":"outputs","id":"MVtQM1cX9tQnpNMeqenIy","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"45fa30aa01de3ef1b6dadc47c8cfd86f","path":"/build/45fa30aa01de3ef1b6dadc47c8cfd86f.png"},"text/plain":{"content":"<IPython.core.display.Image object>","content_type":"text/plain"}}},"children":[],"key":"O2ljfIji0Q"}],"key":"EqHvw0mZ4L"}],"key":"IRivx4AEH2"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"And the architecture actually takes this interesting hierarchical sort of approach to predicting the next character in a sequence with this tree-like structure:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xTWdwD9yMV"}],"key":"CWPI5bzHql"}],"key":"iWp5LpJcNp"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from IPython.display import Image, display\n\ndisplay(Image(filename=\"wavenet_fig3.png\"))","key":"m0oWvKx8oN"},{"type":"outputs","id":"_Ft8XXO_psR-qxlcY7TmQ","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"198c39366ff68e8b03ccb06df349f47a","path":"/build/198c39366ff68e8b03ccb06df349f47a.png"},"text/plain":{"content":"<IPython.core.display.Image object>","content_type":"text/plain"}}},"children":[],"key":"j4HsjzQtoZ"}],"key":"MOlyRqru2P"}],"key":"MSFsMbinMl"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"And this is the architecture:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kVHgOj1haS"}],"key":"JK7kd6CvZj"}],"key":"zOYH26V98c"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from IPython.display import Image, display\n\ndisplay(Image(filename=\"wavenet_fig4.png\"))","key":"IGW2Q9KKaY"},{"type":"outputs","id":"qRLcVVETSAS4LU09tacgU","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"54272b3d206b11fb693990a90d767eee","path":"/build/54272b3d206b11fb693990a90d767eee.png"},"text/plain":{"content":"<IPython.core.display.Image object>","content_type":"text/plain"}}},"children":[],"key":"Ixel05AuWa"}],"key":"w1emhHmrON"}],"key":"M1Wid3qdsh"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"And we’re going to implement it in this lesson. So let’s get started!","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sYhOQunU4a"}],"key":"vn3YdH5GP3"}],"key":"qiiXXoHOl8"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Starter code walkthrough","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YzpAwuJMLq"}],"identifier":"starter-code-walkthrough","label":"Starter code walkthrough","html_id":"starter-code-walkthrough","implicit":true,"key":"LShllh33xy"}],"visibility":"show","key":"rdtvkOCBrZ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The starter code for this part is very similar to where we ended up in ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MTgEoQpN5v"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"makemore","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XwXMMaJOFK"}],"key":"epi7tI0if5"},{"type":"text","value":" (part 3). So very briefly, we are doing imports:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ra2ABlCbXx"}],"key":"VYaodLudJX"}],"key":"xjOqqQzkDx"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import random\nrandom.seed(42)\nimport torch\nimport torch.nn.functional as F\nimport matplotlib.pyplot as plt # for making figures\nif IN_COLAB:\n    %matplotlib inline\nelse:\n    %matplotlib ipympl\nSEED = 2147483647","key":"o436Fp76sr"},{"type":"outputs","id":"F7oilRJKA1S1gDw9pr5DT","children":[],"key":"FPAM6GT49K"}],"key":"khSvnXtRfx"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We are reading our data set of words:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TZnNzkVGZ9"}],"key":"eUIg855K5q"}],"key":"Af8f4Cbiwd"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# read in all the words\nwords = open(\"names.txt\", \"r\").read().splitlines()\nprint(len(words))\nprint(max(len(w) for w in words))\nprint(words[:8])","key":"IV2ujAmF67"},{"type":"outputs","id":"ghBwFNGaqpo_Nr4zPwpbR","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"32033\n15\n['emma', 'olivia', 'ava', 'isabella', 'sophia', 'charlotte', 'mia', 'amelia']\n"},"children":[],"key":"rf5oTjaywP"}],"key":"r67bw6DdEy"}],"key":"WjWG5glACF"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"And we are processing the dataset of words into lots and lots of individual examples:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HQrqRRqUut"}],"key":"UeLVNMBA67"}],"key":"QSWohBVPQD"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# build the vocabulary of characters and mappings to/from integers\nchars = sorted(list(set(\"\".join(words))))\nctoi = {s: i + 1 for i, s in enumerate(chars)}\nctoi[\".\"] = 0\nitoc = {i: s for s, i in ctoi.items()}\nvocab_size = len(itoc)\nprint(itoc)\nprint(vocab_size)","key":"rigWGp4Bbq"},{"type":"outputs","id":"FrpxCmurS-C2swI6sA9Lr","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"{1: 'a', 2: 'b', 3: 'c', 4: 'd', 5: 'e', 6: 'f', 7: 'g', 8: 'h', 9: 'i', 10: 'j', 11: 'k', 12: 'l', 13: 'm', 14: 'n', 15: 'o', 16: 'p', 17: 'q', 18: 'r', 19: 's', 20: 't', 21: 'u', 22: 'v', 23: 'w', 24: 'x', 25: 'y', 26: 'z', 0: '.'}\n27\n"},"children":[],"key":"sO2kVRw2Cr"}],"key":"yAc1tNI0do"}],"key":"xJo1YR3eCM"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def build_dataset(words, block_size):\n    x, y = [], []\n    for w in words:\n        context = [0] * block_size\n        for ch in w + \".\":\n            ix = ctoi[ch]\n            x.append(context)\n            y.append(ix)\n            context = context[1:] + [ix]  # crop and append\n    x = torch.tensor(x)\n    y = torch.tensor(y)\n    print(x.shape, y.shape)\n    return x, y","key":"EOWiIknZVV"},{"type":"outputs","id":"w7HN9-ig34uvEBn6tk-jr","children":[],"key":"LII9IMcTh5"}],"key":"yPU32IelSR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def build_all_datasets(block_size):\n    random.shuffle(words)\n    n1 = int(0.8 * len(words))\n    n2 = int(0.9 * len(words))\n    xtrain_dataset = build_dataset(words[:n1], block_size)  # 80%\n    xval_dataset = build_dataset(words[n1:n2], block_size)  # 10%\n    xtest_dataset = build_dataset(words[n2:], block_size)  # 10%\n    return xtrain_dataset, xval_dataset, xtest_dataset","key":"bM4kCSoAwr"},{"type":"outputs","id":"oeFtyE8kh-bpBPX8GuaHz","children":[],"key":"JasTIa1MHA"}],"key":"r45z7KNiGK"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def print_next_character(xtrain, ytrain):\n    for x, y in zip(xtrain, ytrain):\n        print(\"\".join(itoc[ix.item()] for ix in x), \"-->\", itoc[y.item()])","key":"pJ6My8IvAR"},{"type":"outputs","id":"Vkj2LjQwMxLv8kuagvFzN","children":[],"key":"bhRf6rRXeq"}],"key":"zH9FGYR2Bm"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Specifically many examples of...","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"g2t62PbGqS"}],"key":"M0XCroDuMS"}],"key":"dku0G1hgXl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"block_size = (\n    3  # context length: how many characters do we take to predict the next one?\n)\n(xtrain, ytrain), (xval, yval), (xtest, ytest) = build_all_datasets(block_size)","key":"rNQTYA5uxm"},{"type":"outputs","id":"DP_Cw27cYuI5LAdWXdxIw","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"torch.Size([182625, 3]) torch.Size([182625])\ntorch.Size([22655, 3]) torch.Size([22655])\ntorch.Size([22866, 3]) torch.Size([22866])\n"},"children":[],"key":"be2db04Tyx"}],"key":"qFWxnIqDRZ"}],"key":"N1TMyRrLW0"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"... ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"m8TH1vtZTE"},{"type":"inlineCode","value":"block_size=3","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"g6NAMkiWnr"},{"type":"text","value":" characters and we are trying to predict the fourth one:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iMq1YabpNn"}],"key":"Xb4ubGkVf4"}],"key":"mITY5ocwPb"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print_next_character(xtrain[:20], ytrain[:20])","key":"QsMrbZ7KIN"},{"type":"outputs","id":"lQ86huNJnBqmtFVM-oeky","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"... --> y\n..y --> u\n.yu --> h\nyuh --> e\nuhe --> n\nhen --> g\neng --> .\n... --> d\n..d --> i\n.di --> o\ndio --> n\nion --> d\nond --> r\nndr --> e\ndre --> .\n... --> x\n..x --> a\n.xa --> v\nxav --> i\navi --> e\n"},"children":[],"key":"mfd9NTJiUl"}],"key":"Hk0gTWMKyi"}],"key":"RQJjODTw94"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Basically, we are breaking down each of these word into little problems of “given ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"wl3rFdxsqa"},{"type":"text","value":"3","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RZtY0M78pu"},{"type":"text","value":" characters, predict the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"p1bOY0Ct8D"},{"type":"inlineMath","value":"4th","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mi>t</mi><mi>h</mi></mrow><annotation encoding=\"application/x-tex\">4th</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord\">4</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span></span></span></span>","key":"i5OI36L3ky"},{"type":"text","value":" one”. So this is our data set and this is what we’re trying to get the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NzVEXebxEV"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"v29HD0EIlY"}],"key":"wCGjsEK6C7"},{"type":"text","value":" to do. Now in ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RuB5ldHN55"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"makemore","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JOqMsdaVCo"}],"key":"lJu4PXqVVN"},{"type":"text","value":" (part 3), we started to develop our code around these following layer modules. We’re doing this because we want to think of these modules as lego building blocks that we can sort of stack up into ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XW3ScdqP5H"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LeqDKLbFO7"}],"key":"NzLXlPKed1"},{"type":"text","value":"s and we can feed data between these layers and stack them up into sort of graphs. Now we also developed these layers to have APIs and signatures very similar to ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hboChnmUhz"},{"type":"link","url":"https://pytorch.org/docs/stable/nn.html","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"those that are found in PyTorch","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JWaUwDrSLG"}],"urlSource":"https://pytorch.org/docs/stable/nn.html","key":"mbWm2hXR0A"},{"type":"text","value":". And so we have the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tKl1IjtN9T"},{"type":"inlineCode","value":"Linear","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xS0QudjVzO"},{"type":"text","value":" layer, the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mTIDrqpkKn"},{"type":"inlineCode","value":"BatchNorm1d","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bKhviwcOqD"},{"type":"text","value":" layer and the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sg0fq4yoet"},{"type":"inlineCode","value":"Tanh","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"A87wQLP4qh"},{"type":"text","value":" layer that we developed previously:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"y4kxFbvHb2"}],"key":"whh2HceSsO"}],"key":"Xwm8efnp5u"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"class Linear:\n    def __init__(self, fan_in, fan_out, bias=True):\n        self.weight = torch.randn((fan_in, fan_out)) / fan_in**0.5\n        self.bias = torch.zeros(fan_out) if bias else None\n\n    def __call__(self, x):\n        self.out = x @ self.weight\n        if self.bias is not None:\n            self.out += self.bias\n        return self.out\n\n    def parameters(self):\n        return [self.weight] + ([] if self.bias is None else [self.bias])\n\n\nclass BatchNorm1d:\n    def __init__(self, dim, eps=1e-5, momentum=0.1):\n        self.eps = eps\n        self.momentum = momentum\n        self.training = True\n        # parameters (trained with backprop)\n        self.gamma = torch.ones(dim)\n        self.beta = torch.zeros(dim)\n        # buffers (trained with a running 'momentum update')\n        self.running_mean = torch.zeros(dim)\n        self.running_var = torch.ones(dim)\n\n    def __call__(self, x):\n        # calculate the forward pass\n        if self.training:\n            xmean = x.mean(0, keepdim=True)  # batch mean\n            xvar = x.var(0, keepdim=True)  # batch variance\n        else:\n            xmean = self.running_mean\n            xvar = self.running_var\n        xhat = (x - xmean) / torch.sqrt(xvar + self.eps)  # normalize to unit variance\n        self.out = self.gamma * xhat + self.beta\n        # update the buffers\n        if self.training:\n            with torch.no_grad():\n                self.running_mean = (\n                    1 - self.momentum\n                ) * self.running_mean + self.momentum * xmean\n                self.running_var = (\n                    1 - self.momentum\n                ) * self.running_var + self.momentum * xvar\n        return self.out\n\n    def parameters(self):\n        return [self.gamma, self.beta]\n\n\nclass Tanh:\n    def __call__(self, x):\n        self.out = torch.tanh(x)\n        return self.out\n\n    def parameters(self):\n        return []","key":"Yr8Eu5OWI8"},{"type":"outputs","id":"cELcFYUQQXXfG62iFqRMp","children":[],"key":"On2O9tR25K"}],"key":"QS71bwtca3"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Αnd ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Mb8URQj8vK"},{"type":"inlineCode","value":"Linear","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zvH68H9KgZ"},{"type":"text","value":" just does a matrix multiply in the forward pass of this module, ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"e9yiONoYtu"},{"type":"inlineCode","value":"BatchNorm1d","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mDzMNzL0G9"},{"type":"text","value":" of course is this crazy layer that we developed in the previous lecture. What’s crazy about it is... well there’s many things. Number one, it has these running mean and variances that are trained outside of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"EewLfwvG2F"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"backprop","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UqV0Wdx6ad"}],"key":"sdOmzB2TxL"},{"type":"text","value":". They are trained using exponential moving average inside this layer when we call the forward pass. In addition to that, there’s this ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RhiVRBP4Bc"},{"type":"inlineCode","value":"self.training","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JUbmPZ9oLX"},{"type":"text","value":" flag because the behavior of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hukgxDQWo3"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"batchnorm","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PAR16MoPGq"}],"key":"disnyWSEDp"},{"type":"text","value":" is different during train time and evaluation time. And so suddenly we have to be very careful that ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gI8x9ZJF0P"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"batchnorm","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MTCzgGfgsd"}],"key":"xzUQiSed36"},{"type":"text","value":" is in its correct state. That it’s in the evaluation state or training state. So that’s something to now keep track of something that sometimes introduces bugs because you forget to put it into the right mode. And finally, we saw that ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ozive7hugm"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"batchnorm","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SQYSfpuSnF"}],"key":"f2pTQEUCAh"},{"type":"text","value":" couples the statistics or the activations across the examples in the batch. So normally we thought of the batch as just an efficiency thing, but now we are coupling the computation across batch elements and it’s done for the purposes of controlling the activation statistics as we saw in the previous video. So ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HtZ3g9mf3N"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"batchnorm","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"R4XAhhDAY2"}],"key":"wW8EdZvUdK"},{"type":"text","value":" is a very weird layer because you have to modulate the training and eval phase. What’s more, you have to wait for the mean and the variance to settle and to actually reach a steady state and a state can become the source of many bugs, usually. And now let’s define the appropriate functions:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FPlSIGER7B"}],"key":"lpVg50daDo"}],"key":"ybJFO3vJoO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# seed rng for reproducability\ntorch.manual_seed(42)","key":"OifLM6ZAv9"},{"type":"outputs","id":"BqFdDtZwJmMbuFrDCOtyg","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":23,"metadata":{},"data":{"text/plain":{"content":"<torch._C.Generator at 0x7ffa740b3d90>","content_type":"text/plain"}}},"children":[],"key":"Ao2ePvrpjA"}],"key":"KTdS3UOgX2"}],"key":"RtzGNmKEts"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"n_embd = 10  # the dimensionality of the character embedding vectors\nn_hidden = 200  # the number of neurons in the hidden layer of the MLP\n\n\ndef define_nn(block_size, n_embd, n_hidden):\n    global C\n    C = torch.randn((vocab_size, n_embd))\n    n_inputs = n_embd * block_size\n    n_outputs = vocab_size\n    layers = [\n        Linear(n_inputs, n_hidden, bias=False),\n        BatchNorm1d(n_hidden),\n        Tanh(),\n        Linear(n_hidden, n_outputs),\n    ]\n    # parameter init\n    with torch.no_grad():\n        layers[-1].weight *= 0.1  # last layer make less confident\n    parameters = [C] + [p for l in layers for p in l.parameters()]\n    print(sum(p.nelement() for p in parameters))  # number of parameters in total\n    for p in parameters:\n        p.requires_grad = True\n    return layers, parameters","key":"fvlxXD7SCB"},{"type":"outputs","id":"e-kft9uH5HLH1rXktPg1O","children":[],"key":"jQAYj7ghsR"}],"key":"jxtFaJlYjh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def forward(layers, xb, yb):\n    emb = C[xb]  # embed the characters into vectors\n    x = emb.view(emb.shape[0], -1)  # concatenate the vectors\n    for layer in layers:\n        x = layer(x)\n    loss = F.cross_entropy(x, yb)  # loss function\n    return loss","key":"xXKNm4bzrJ"},{"type":"outputs","id":"8Cdiju_TFfcKVpFVO-ZKd","children":[],"key":"CPaMPA9R6T"}],"key":"f9y8W8DeoT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def backward(parameters, loss):\n    for p in parameters:\n        p.grad = None\n    loss.backward()","key":"GJ2c6XUv0M"},{"type":"outputs","id":"84h8otK8Bt0fjLv4sgJYn","children":[],"key":"ULVmtG0U98"}],"key":"ibXN5D2whE"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def update(parameters, lr):\n    for p in parameters:\n        p.data += -lr * p.grad","key":"f1LR2VRaSb"},{"type":"outputs","id":"Cf4Ul_HsjfEOQhjt8_oQb","children":[],"key":"LHl9QiCXZ1"}],"key":"UQ49KAaQga"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def train(\n    x,\n    y,\n    layers,\n    parameters,\n    initial_lr=0.1,\n    maxsteps=200000,\n    batchsize=32,\n    break_at_step=None,\n):\n    lossi = []\n    for i in range(maxsteps):\n        # minibatch construct\n        bix = torch.randint(0, x.shape[0], (batchsize,))\n        xb, yb = x[bix], y[bix]\n        loss = forward(layers, xb, yb)\n        backward(parameters, loss)\n        lr = initial_lr if i < 150000 else initial_lr / 10\n        update(parameters, lr=lr)\n        # track stats\n        if i % 10000 == 0:  # print every once in a while\n            print(f\"{i:7d}/{maxsteps:7d}: {loss.item():.4f}\")\n        lossi.append(loss.log10().item())\n        if break_at_step is not None and i >= break_at_step:\n            break\n    return lossi","key":"ey0dbMbLau"},{"type":"outputs","id":"DIX9boED3ij5XbdA9Mrcu","children":[],"key":"Qpgz1Q5dWT"}],"key":"MPELC3BB2I"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def trigger_eval_mode(layers):\n    for l in layers:\n        l.training = False","key":"DFPpm8J97N"},{"type":"outputs","id":"QZAIhz5bjpsrErmTcG2U6","children":[],"key":"numxLxzVup"}],"key":"zGKTIQSLgG"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"@torch.no_grad()\ndef infer_loss(layers, x, y, prefix=\"\"):\n    loss = forward(layers, x, y)\n    print(f\"{prefix} {loss}\")\n    return loss","key":"ldkeJfji9k"},{"type":"outputs","id":"Y5--8u_Vnfa43unBGltsV","children":[],"key":"H7B5AQn0IG"}],"key":"unFHmTYdZm"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def sample_from_model(block_size, layers):\n    for _ in range(20):\n        out = []\n        context = [0] * block_size  # initialize with all ...\n        while True:\n            # forward pass the neural net\n            emb = C[torch.tensor([context])]  # (1, block_size, n_embd)\n            x = emb.view(emb.shape[0], -1)  # concatenate the vectors\n            for l in layers:\n                x = l(x)\n            logits = x\n            probs = F.softmax(logits, dim=1)\n            # sample from the distribution\n            ix = torch.multinomial(probs, num_samples=1).item()\n            # shift the context window and track the samples\n            context = context[1:] + [ix]\n            out.append(ix)\n            # if we sample the special '.' token, break\n            if ix == 0:\n                break\n        print(\"\".join(itoc[i] for i in out))  # decode and print the generated word","key":"vC1bsJ9BhJ"},{"type":"outputs","id":"TAJEvBlACWBBOa0qMvcf1","children":[],"key":"O5DBsc0tMK"}],"key":"pLOgO2HMxd"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"These should look somewhat familiar to you by now. Let’s train!","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BYa9TT0Gbk"}],"key":"UXxFhs8jiq"}],"key":"LJBqFodeX1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"layers, parameters = define_nn(block_size, n_embd, n_hidden)\nlossi = train(xtrain, ytrain, layers, parameters)","key":"jFsaZCQVZr"},{"type":"outputs","id":"Xp_KvuWvt0PtjtDQ6Rexx","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"12097\n      0/ 200000: 3.2966\n"},"children":[],"key":"ANv6nYAACz"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"  10000/ 200000: 2.2322\n  20000/ 200000: 2.4111\n  30000/ 200000: 2.1004\n  40000/ 200000: 2.3157\n  50000/ 200000: 2.2104\n  60000/ 200000: 1.9653\n  70000/ 200000: 1.9767\n  80000/ 200000: 2.6738\n  90000/ 200000: 2.0837\n 100000/ 200000: 2.2730\n 110000/ 200000: 1.7491\n 120000/ 200000: 2.2891\n 130000/ 200000: 2.3443\n 140000/ 200000: 2.1731\n 150000/ 200000: 1.8246\n 160000/ 200000: 1.7614\n 170000/ 200000: 2.2419\n 180000/ 200000: 2.0803\n 190000/ 200000: 2.1326\n"},"children":[],"key":"dIub0DEX7W"}],"key":"aK41hHWcTi"}],"key":"rlkRqI55sj"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"plt.figure()\nplt.plot(lossi);","key":"xE3B58HTfi"},{"type":"outputs","id":"qlVRmrfuJxHJt6jLEYc4f","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"c0ff1cdd47ba47c79578bbd5f0c5f983\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"image/png":{"content_type":"image/png","hash":"48e19c2cf41d8f75fc83c18d5baccf0d","path":"/build/48e19c2cf41d8f75fc83c18d5baccf0d.png"},"text/html":{"content_type":"text/html","hash":"a25d5bfbebab9c1f574ead8922d0b080","path":"/build/a25d5bfbebab9c1f574ead8922d0b080.html"},"text/plain":{"content":"Canvas(toolbar=Toolbar(toolitems=[('Home', 'Reset original view', 'home', 'home'), ('Back', 'Back to previous …","content_type":"text/plain"}}},"children":[],"key":"tGtO3ywZwJ"}],"key":"Q3kkAZhxMb"}],"key":"lemou1NRRQ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CBs9eMRcmu"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"loss","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ee4bHYZdCY"}],"key":"aX9OxVetPY"},{"type":"text","value":" function looks very crazy. We should probably fix this. And that’s because ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"O73asICghB"},{"type":"text","value":"32","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"f2BN0YOcWR"},{"type":"text","value":" batch elements are too few. And so you can get very lucky or unlucky in any one of these batches, and it creates a very thicc ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sFFDafXxLq"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"loss","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Yb0awlzlg9"}],"key":"BDiUa8IxMb"},{"type":"text","value":" function. So we’re gonna fix that soon. Now, before we evaluate the trained ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oJLTBOFi9r"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"g7TNZxgsWA"}],"key":"gHNpOpEls6"},{"type":"text","value":" by inferring the training and validation ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CUPnboV9TJ"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"loss","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"V8kh8M4wCC"}],"key":"bIsw7Ij3bC"},{"type":"text","value":", we need to remember because of the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jVCD8uqtRv"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"batchnorm","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"A6c7lQTGdP"}],"key":"s49RcVjQVA"},{"type":"text","value":" layers to set all the layers’ ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"N6oqyIwsDL"},{"type":"inlineCode","value":"training","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"x2HoGYNSZF"},{"type":"text","value":" flag to ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"URvizDWMb8"},{"type":"inlineCode","value":"False","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"q2iRTeClGd"},{"type":"text","value":":","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MVHNUQtP9R"}],"key":"RFQ6AiZ7nv"}],"key":"mEIgpZCL9L"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"trigger_eval_mode(layers)\ninfer_loss(layers, xtrain, ytrain, prefix=\"train\")\ninfer_loss(layers, xval, yval, prefix=\"val\");","key":"ZIKuH8Ev19"},{"type":"outputs","id":"qC_aVE95vxpMhXcFfY7_y","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"train 2.0583250522613525\nval 2.1065292358398438\n"},"children":[],"key":"pusWfWxAFF"}],"key":"paSy3ugc2p"}],"key":"j4YjTZPWBG"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We still have a ways to go, as far as the validation ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Z1YviKldtE"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"loss","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FMGC5H8v6y"}],"key":"ukHre0w68W"},{"type":"text","value":" is concerned. But if we sample from our model, we see that we get relatively name-like results that do no exist in the training set:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"z99sRPtC5a"}],"key":"GaO4dXuh8c"}],"key":"lrOQcYXlgf"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sample_from_model(block_size=block_size, layers=layers)","key":"ZYHMF0SLRG"},{"type":"outputs","id":"-teaqI3k2yPaNfjjY-ibI","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"damiara.\nalyzah.\nfard.\nazalee.\nsayah.\nayvi.\nreino.\nsophemuellani.\nciaub.\nalith.\nsira.\nliza.\njah.\ngrancealynna.\njamaur.\nben.\nquan.\ntorie.\ncoria.\ncer.\n"},"children":[],"key":"dfCJu1iudc"}],"key":"y2M9XueJHi"}],"key":"eGJfGIVlex"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"But we can improve our ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NiMpYynrDk"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"loss","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zVCjPNAz4A"}],"key":"TfApyecEn8"},{"type":"text","value":" and improve our results even further. We’ll start by fixing that thicc loss plot!","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"w6AWW1NAUa"}],"key":"UtYfrVHbZN"}],"key":"L8pB8v8FfC"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Fixing the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iDbtfrK4zs"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"loss","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"likzaQgr79"}],"key":"gbDJZXUhTk"},{"type":"text","value":" plot","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"omiHXct96g"}],"identifier":"fixing-the-loss-plot","label":"Fixing the loss plot","html_id":"fixing-the-loss-plot","implicit":true,"key":"LVUslVa840"}],"key":"JvTxA6Kskg"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"One way to turn this thicc loss plot into a normal one is to only plot the mean. Remember, ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GiQcMdtnF8"},{"type":"inlineCode","value":"lossi","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"O6kgWON7XF"},{"type":"text","value":" is a very long list of floats that contains a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LvYKWOliAM"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"loss","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iYxpN9CTnM"}],"key":"u898bk4V3X"},{"type":"text","value":" for each training episode:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KkUgKZE3sJ"}],"key":"RGH8G61NI4"}],"key":"d7JwHgczyr"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"len(lossi), lossi[:5]","key":"QgkeruGa5S"},{"type":"outputs","id":"0Vv3m87kPwbwHI4uR7p8_","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":36,"metadata":{},"data":{"text/plain":{"content":"(200000,\n [0.5180676579475403,\n  0.5164594054222107,\n  0.507362961769104,\n  0.507546603679657,\n  0.4992470443248749])","content_type":"text/plain"}}},"children":[],"key":"hni8NUrWIs"}],"key":"MBDhesGc7X"}],"key":"JatpiTgIUT"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Let’s segment this very long list into a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aagoCBpvSi"},{"type":"inlineMath","value":"2D","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">2D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord\">2</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span>","key":"aEadPMsK6u"},{"type":"text","value":" tensor of rows, with each row containing ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"C3CI7kMTXY"},{"type":"text","value":"1000","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"y4aQTq81R9"},{"type":"text","value":" loss values:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"z8gEvO8swn"}],"key":"Nm1Vf6DMWQ"}],"key":"BM9J9Qw9Gg"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"t_loss = torch.tensor(lossi).view(-1, 1000)\nt_loss","key":"r04PZnh6z4"},{"type":"outputs","id":"b5g6LB6yMHHSu2vGflNxV","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":37,"metadata":{},"data":{"text/plain":{"content":"tensor([[0.5181, 0.5165, 0.5074,  ..., 0.4204, 0.3860, 0.4014],\n        [0.3937, 0.3930, 0.4177,  ..., 0.3788, 0.3896, 0.4054],\n        [0.3426, 0.4191, 0.3918,  ..., 0.4447, 0.4419, 0.2821],\n        ...,\n        [0.3625, 0.3517, 0.3376,  ..., 0.3266, 0.3191, 0.3271],\n        [0.2550, 0.3659, 0.2968,  ..., 0.2744, 0.3853, 0.3300],\n        [0.3041, 0.2740, 0.3213,  ..., 0.3081, 0.4082, 0.3207]])","content_type":"text/plain"}}},"children":[],"key":"nJkrLIWotO"}],"key":"Sil0kyaAsY"}],"key":"kJ03wLXmQV"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now, if we take the mean of each row, we end up with a list of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vo0ilhxcbU"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"loss","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JIsgvzTs2M"}],"key":"FG8jcfdKBK"},{"type":"text","value":" averages:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jMyIS4vxTn"}],"key":"DSnXxeC0C4"}],"key":"z9uU84rzjB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"mean_t_loss = t_loss.mean(1)\nmean_t_loss","key":"bftjXlt8Kg"},{"type":"outputs","id":"UliBNGYrfb-VBYUcIw41U","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":38,"metadata":{},"data":{"text/plain":{"content":"tensor([0.4059, 0.3791, 0.3698, 0.3681, 0.3657, 0.3639, 0.3624, 0.3593, 0.3557,\n        0.3561, 0.3516, 0.3515, 0.3504, 0.3501, 0.3491, 0.3477, 0.3498, 0.3474,\n        0.3494, 0.3449, 0.3456, 0.3440, 0.3452, 0.3461, 0.3429, 0.3456, 0.3458,\n        0.3438, 0.3408, 0.3437, 0.3435, 0.3407, 0.3424, 0.3412, 0.3415, 0.3404,\n        0.3419, 0.3391, 0.3414, 0.3396, 0.3392, 0.3408, 0.3394, 0.3416, 0.3389,\n        0.3390, 0.3376, 0.3407, 0.3364, 0.3376, 0.3393, 0.3362, 0.3371, 0.3349,\n        0.3393, 0.3369, 0.3363, 0.3349, 0.3338, 0.3386, 0.3366, 0.3388, 0.3370,\n        0.3379, 0.3349, 0.3378, 0.3325, 0.3358, 0.3353, 0.3390, 0.3369, 0.3366,\n        0.3354, 0.3350, 0.3375, 0.3347, 0.3352, 0.3352, 0.3318, 0.3359, 0.3348,\n        0.3338, 0.3350, 0.3367, 0.3331, 0.3333, 0.3346, 0.3356, 0.3339, 0.3339,\n        0.3332, 0.3331, 0.3352, 0.3356, 0.3350, 0.3335, 0.3330, 0.3299, 0.3344,\n        0.3350, 0.3318, 0.3295, 0.3328, 0.3336, 0.3345, 0.3341, 0.3319, 0.3342,\n        0.3329, 0.3299, 0.3346, 0.3312, 0.3312, 0.3344, 0.3340, 0.3305, 0.3319,\n        0.3344, 0.3302, 0.3315, 0.3335, 0.3319, 0.3345, 0.3326, 0.3331, 0.3319,\n        0.3317, 0.3331, 0.3316, 0.3313, 0.3319, 0.3340, 0.3306, 0.3329, 0.3306,\n        0.3322, 0.3332, 0.3313, 0.3309, 0.3348, 0.3297, 0.3324, 0.3305, 0.3311,\n        0.3316, 0.3308, 0.3301, 0.3323, 0.3289, 0.3313, 0.3199, 0.3201, 0.3196,\n        0.3233, 0.3184, 0.3179, 0.3180, 0.3172, 0.3175, 0.3176, 0.3200, 0.3194,\n        0.3196, 0.3195, 0.3186, 0.3166, 0.3192, 0.3179, 0.3168, 0.3171, 0.3173,\n        0.3188, 0.3175, 0.3176, 0.3174, 0.3197, 0.3182, 0.3167, 0.3187, 0.3217,\n        0.3165, 0.3187, 0.3144, 0.3165, 0.3183, 0.3187, 0.3179, 0.3161, 0.3182,\n        0.3177, 0.3171, 0.3187, 0.3194, 0.3183, 0.3157, 0.3156, 0.3167, 0.3168,\n        0.3187, 0.3179])","content_type":"text/plain"}}},"children":[],"key":"I5ka6V0dvu"}],"key":"QI0r7Or8Vv"}],"key":"ge6UtmEjKb"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"If we plot this tensor list of mean losses, we should get a nicer ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kighcp8ude"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"loss","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YZac8T2H11"}],"key":"qV7vaPXjqp"},{"type":"text","value":" plot:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vTgPq5k6Lw"}],"key":"HjNhNazN4z"}],"key":"pxN1EeK7qE"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"plt.figure()\nplt.plot(mean_t_loss);","key":"R5zt6hkeoO"},{"type":"outputs","id":"WSLoBuBcgkCFgFRwipe84","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"42dc20cba22c45458c6f9877637adf70\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"image/png":{"content_type":"image/png","hash":"5d9ce90e435b7c612969d574e5fe3c25","path":"/build/5d9ce90e435b7c612969d574e5fe3c25.png"},"text/html":{"content_type":"text/html","hash":"069f0424ea33d6e559bb93a29a286a49","path":"/build/069f0424ea33d6e559bb93a29a286a49.html"},"text/plain":{"content":"Canvas(toolbar=Toolbar(toolitems=[('Home', 'Reset original view', 'home', 'home'), ('Back', 'Back to previous …","content_type":"text/plain"}}},"children":[],"key":"Qy8IM5lQvW"}],"key":"ybnQexc3Z9"}],"key":"bI3NxMYowd"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now, the progress we make during training is much more clearly visible! Also, notice the learning rate decay, where the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uQ2WjKoFNS"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"loss","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NeA6Z6Etub"}],"key":"oenRaRxAVE"},{"type":"text","value":" drops to a even lower minimum. This is the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Bd1ht9j4QD"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"loss","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tXgYom9Bub"}],"key":"Oyf9j4KaXI"},{"type":"text","value":" plot we are going to be using going forward.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FQ51Q3wmw7"}],"key":"T1Dpk1lmSR"}],"key":"QlIRljuCXX"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"torchifying the code: layers, containers, torch.nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"esvdG8trEO"}],"identifier":"torchifying-the-code-layers-containers-torch-nn","label":"torchifying the code: layers, containers, torch.nn","html_id":"torchifying-the-code-layers-containers-torch-nn","implicit":true,"key":"JUXbL5iPIE"}],"visibility":"show","key":"Lw8sJsOOaG"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now it’s time to simplify our forward function a little bit. Notice how the embeddings and flattening operations are calculated outside of the layers:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DgF93nhqUR"}],"key":"JNCa36umbS"}],"key":"hI6ysO4QM4"},{"type":"block","kind":"notebook-content","children":[{"type":"code","lang":"python","value":"def forward(layers, xb, yb):\n    emb = C[xb] # embed the characters into vectors\n    x = emb.view(emb.shape[0], -1) # concatenate the vectors\n    for layer in layers:\n        ...","position":{"start":{"line":1,"column":1},"end":{"line":7,"column":1}},"key":"EswfTlWILP"}],"key":"KHfUzqbaUS"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"To start tidying things up, let’s mirror ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tu1EaUqO97"},{"type":"link","url":"https://pytorch.org/docs/stable/generated/torch.nn.Embedding.html#torch.nn.Embedding","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"inlineCode","value":"torch.nn.Embedding","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"A9JpIItPDY"}],"urlSource":"https://pytorch.org/docs/stable/generated/torch.nn.Embedding.html#torch.nn.Embedding","key":"ActqjLG4Qt"},{"type":"text","value":" and ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kWv5QyvtqK"},{"type":"link","url":"https://pytorch.org/docs/stable/generated/torch.nn.Flatten.html#torch.nn.Flatten","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"inlineCode","value":"torch.nn.Flatten","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BrqWeCOcsx"}],"urlSource":"https://pytorch.org/docs/stable/generated/torch.nn.Flatten.html#torch.nn.Flatten","key":"qvj6o1HFfp"},{"type":"text","value":" with our own incredibly simplified equivalent modules:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DM1US0PQLP"}],"key":"QPDrmpJwzB"}],"key":"ZJeHHnlp2g"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"class Embedding:\n    def __init__(self, n_embd, embd_dim):\n        self.weight = torch.randn((n_embd, embd_dim))\n\n    def __call__(self, ix):\n        self.out = self.weight[ix]\n        return self.out\n\n    def parameters(self):\n        return [self.weight]","key":"rMtsvETxqc"},{"type":"outputs","id":"LOY30tU4UNaJ_pGgiI0mp","children":[],"key":"uYNaVimJn2"}],"key":"lUBLz3N3Dg"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"class Flatten:\n    def __call__(self, x):\n        self.out = x.view(x.shape[0], -1)\n        return self.out\n\n    def parameters(self):\n        return []","key":"RPByD6K1W3"},{"type":"outputs","id":"Xvhogo-jt-xe9W5YSpW4V","children":[],"key":"H8NX2LXsDO"}],"key":"NjQ2qqm1zr"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"These will simply be responsible for indexing and flattening. We can now simplify our forward pass by including the embedding and flattening operations as modules in the definition of the layers:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"A9ZPVwkkh3"}],"key":"oaHYjSf9qh"}],"key":"zEQqR9LhVP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def define_nn(block_size, n_embd, n_hidden):\n    n_inputs = n_embd * block_size\n    n_outputs = vocab_size\n    layers = [\n        Embedding(vocab_size, n_embd),\n        Flatten(),\n        Linear(n_inputs, n_hidden, bias=False),\n        BatchNorm1d(n_hidden),\n        Tanh(),\n        Linear(n_hidden, n_outputs),\n    ]\n    # parameter init\n    with torch.no_grad():\n        layers[-1].weight *= 0.1  # last layer make less confident\n    parameters = [p for l in layers for p in l.parameters()]\n    print(sum(p.nelement() for p in parameters))  # number of parameters in total\n    for p in parameters:\n        p.requires_grad = True\n    return layers, parameters","key":"g43NWQrq8d"},{"type":"outputs","id":"faoMF2zhFBYnHCMxqD0Nc","children":[],"key":"tgh7aQMMjG"}],"key":"yw6yiJYoOO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def forward(layers, xb, yb):\n    x = xb\n    for layer in layers:\n        x = layer(x)\n    loss = F.cross_entropy(x, yb)  # loss function\n    return loss","key":"WfezffhKMn"},{"type":"outputs","id":"532O1a-_YvMTIYgM1FY8O","children":[],"key":"Gzce4mHx5O"}],"key":"abZYLhN3j5"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Awesome. Now we can even further simplify our forward pass by replacing the list that contains our layers with our simplified implementation of the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nXXJlyeGbk"},{"type":"link","url":"https://pytorch.org/docs/stable/generated/torch.nn.Sequential.html#torch.nn.Sequential","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"inlineCode","value":"torch.nn.Sequential","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"V4rEo08yx0"}],"urlSource":"https://pytorch.org/docs/stable/generated/torch.nn.Sequential.html#torch.nn.Sequential","key":"Q8W6QXbS6J"},{"type":"text","value":" container: this object contains layers and the functionality to iteratively pass data through them. Meaning that we now define a bunch of layers as a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Q8LtxSBq4P"},{"type":"inlineCode","value":"Sequential","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QEo2y1jeb0"},{"type":"text","value":" object (i.e. a model) through which we can pass input data (e.g. ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Xy3nsuWBSB"},{"type":"inlineCode","value":"x","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oZASQNxQDp"},{"type":"text","value":"), without the need to explicitly loop.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TKrN1OGH6q"}],"key":"AdhUGUJvSQ"}],"key":"CoyXcMkoFT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"class Sequential:\n    def __init__(self, layers):\n        self.layers = layers\n\n    def __call__(self, x):\n        for layer in self.layers:\n            x = layer(x)\n        self.out = x\n        return self.out\n\n    def parameters(self):\n        # get parameters of all layers and stretch them out into one list\n        return [p for layer in self.layers for p in layer.parameters()]","key":"C4ENPUbsce"},{"type":"outputs","id":"NGpjWNcNtXimf-t74_V5Y","children":[],"key":"UgwZcrVrGe"}],"key":"UUxGkaoiAt"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Let’s now further simplify our functions by replacing the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"frJKzEfw1z"},{"type":"inlineCode","value":"layers","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CHjx2PhXxv"},{"type":"text","value":" list with ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"obBn0wOYcC"},{"type":"inlineCode","value":"model","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"u5IGogMxlT"},{"type":"text","value":", a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JYbsAXxbzL"},{"type":"inlineCode","value":"Sequential","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uGU90Odfi3"},{"type":"text","value":" object:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Y5m7No7zjZ"}],"key":"YskbHllhfZ"}],"key":"PRxyzcDPcF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def define_nn(block_size, n_embd, n_hidden):\n    n_inputs = n_embd * block_size\n    n_outputs = vocab_size\n    model = Sequential(\n        [\n            Embedding(vocab_size, n_embd),\n            Flatten(),\n            Linear(n_inputs, n_hidden, bias=False),\n            BatchNorm1d(n_hidden),\n            Tanh(),\n            Linear(n_hidden, n_outputs),\n        ]\n    )\n    # parameter init\n    with torch.no_grad():\n        model.layers[-1].weight *= 0.1  # last layer make less confident\n    parameters = model.parameters()\n    print(sum(p.nelement() for p in parameters))  # number of parameters in total\n    for p in parameters:\n        p.requires_grad = True\n    return model, parameters","key":"Bp1XjAttoo"},{"type":"outputs","id":"2DI6fz_b-ol-R5seGuowg","children":[],"key":"huHFhZiPtO"}],"key":"TvdkjL3Lw9"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def forward(model, xb, yb):\n    logits = model(xb)\n    loss = F.cross_entropy(logits, yb)  # loss function\n    return loss","key":"eoBraBbF2B"},{"type":"outputs","id":"BWus9CPINwS9eJvlb5jDY","children":[],"key":"SFE54iDrXW"}],"key":"Sfcti9Piub"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def train(\n    x,\n    y,\n    model,\n    parameters,\n    initial_lr=0.1,\n    maxsteps=200000,\n    batchsize=32,\n    break_at_step=None,\n):\n    lossi = []\n    for i in range(maxsteps):\n        # minibatch construct\n        bix = torch.randint(0, x.shape[0], (batchsize,))\n        xb, yb = x[bix], y[bix]\n        loss = forward(model, xb, yb)\n        backward(parameters, loss)\n        lr = initial_lr if i < 150000 else initial_lr / 10\n        update(parameters, lr=lr)\n        # track stats\n        if i % 10000 == 0:  # print every once in a while\n            print(f\"{i:7d}/{maxsteps:7d}: {loss.item():.4f}\")\n        lossi.append(loss.log10().item())\n        if break_at_step is not None and i >= break_at_step:\n            break\n    return lossi","key":"u532sOdxtE"},{"type":"outputs","id":"BX2eNC9fv7qZrO6-h43OO","children":[],"key":"ZpwCAdZeLy"}],"key":"cb53kUnrTb"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def trigger_eval_mode(model):\n    for l in model.layers:\n        l.training = False","key":"X3wH3UdwBA"},{"type":"outputs","id":"RyIbGO2MkVuQH6kvlMl50","children":[],"key":"YNIsAT77rs"}],"key":"pmohuZKh7r"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"@torch.no_grad()\ndef infer_loss(model, x, y, prefix=\"\"):\n    loss = forward(model, x, y)\n    print(f\"{prefix} {loss}\")\n    return loss","key":"M2MRQApRt7"},{"type":"outputs","id":"CM32gxfNQrnon0Bn9BiE5","children":[],"key":"BC2leexqZU"}],"key":"TMMNs26cQB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def sample_from_model(block_size, model):\n    for _ in range(20):\n        out = []\n        context = [0] * block_size  # initialize with all ...\n        while True:\n            # forward pass the neural net\n            logits = model(torch.tensor([context]))\n            probs = F.softmax(logits, dim=1)\n            # sample from the distribution\n            ix = torch.multinomial(probs, num_samples=1).item()\n            # shift the context window and track the samples\n            context = context[1:] + [ix]\n            out.append(ix)\n            # if we sample the special '.' token, break\n            if ix == 0:\n                break\n        print(\"\".join(itoc[i] for i in out))  # decode and print the generated word","key":"Mirxeu9Pdo"},{"type":"outputs","id":"T6uSUODIRWeuQ39NRqPlY","children":[],"key":"Rdr7N6Dutf"}],"key":"W2p4hvPlHb"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"And let’s verify that our new definitions work by re-training our ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TepMLP1thQ"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sSJQ1JfRBR"}],"key":"mbatG83uAG"},{"type":"text","value":":","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"goc59TpmIR"}],"key":"ENuL2XsGQF"}],"key":"Efkfy1rtqZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model, parameters = define_nn(block_size, n_embd, n_hidden)\nlossi = train(xtrain, ytrain, model, parameters)","key":"EY3lUNnubA"},{"type":"outputs","id":"4p5XYgwLkfbZ3__iwiPgQ","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"12097\n      0/ 200000: 3.3055\n  10000/ 200000: 2.1954\n  20000/ 200000: 2.2630\n  30000/ 200000: 2.0618\n  40000/ 200000: 2.0468\n  50000/ 200000: 2.1775\n  60000/ 200000: 2.1750\n  70000/ 200000: 1.9390\n  80000/ 200000: 2.1816\n  90000/ 200000: 2.0516\n 100000/ 200000: 2.0578\n 110000/ 200000: 2.2706\n 120000/ 200000: 2.3313\n 130000/ 200000: 2.1557\n 140000/ 200000: 2.0983\n 150000/ 200000: 1.9418\n 160000/ 200000: 1.9421\n 170000/ 200000: 2.1256\n 180000/ 200000: 2.2467\n 190000/ 200000: 1.6821\n"},"children":[],"key":"fOR0IggBxI"}],"key":"kw4olUteB4"}],"key":"r8TIlTIYcP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"plt.figure()\nplt.plot(torch.tensor(lossi).view(-1, 1000).mean(1));","key":"MuQhREkTu7"},{"type":"outputs","id":"5M_Kn0z3_AxeQ4rntaljB","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"3bb3fea1b9d14a5aa8d6287c63f7ddac\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"image/png":{"content_type":"image/png","hash":"dc071225b20724ced3b45fdcad310314","path":"/build/dc071225b20724ced3b45fdcad310314.png"},"text/html":{"content_type":"text/html","hash":"528384c689a08e25b51452974422c1bb","path":"/build/528384c689a08e25b51452974422c1bb.html"},"text/plain":{"content":"Canvas(toolbar=Toolbar(toolitems=[('Home', 'Reset original view', 'home', 'home'), ('Back', 'Back to previous …","content_type":"text/plain"}}},"children":[],"key":"qwdFn9Nu8l"}],"key":"PniPENetSi"}],"key":"PAAkuiYW2a"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"trigger_eval_mode(model)\ninfer_loss(model, xtrain, ytrain, prefix=\"train\")\ninfer_loss(model, xval, yval, prefix=\"val\");","key":"IkJFQjm36d"},{"type":"outputs","id":"76ZbQGKJUqZwvPUCQInCs","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"train 2.0581207275390625\nval 2.105104684829712\n"},"children":[],"key":"E0Lpdo0RyZ"}],"key":"NobVqOTdSs"}],"key":"iirMdIhYbl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sample_from_model(block_size, model)","key":"BrXCVQe607"},{"type":"outputs","id":"GJYYEvPZj5XZ6dZOES5ji","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"masea.\niman.\nryy.\nayee.\nhavajine.\nmiliakendalikain.\namagntanton.\naviona.\njah.\nwiseegh.\navon.\nman.\ntovi.\nsullessa.\nmarcuz.\njazia.\nabellabell.\nathin.\nahkiara.\nkrister.\n"},"children":[],"key":"UMCHAHQB6N"}],"key":"F7xXLeivVp"}],"key":"q2HCR468pD"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Cool. Now it’s time to decrease the loss even further by scaling up our model to make it bigger and deeper!","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xbMSnazQmI"}],"key":"TA1BGBTUzd"}],"key":"heQmEt8jhg"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"WaveNet","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"q5rNy9axun"}],"key":"N7fMH7IdcM"},{"type":"text","value":" overview","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kohRbBQaMh"}],"identifier":"wavenet-overview","label":"WaveNet overview","html_id":"wavenet-overview","implicit":true,"key":"FJTWUvTql3"}],"visibility":"show","key":"HkQz5pQElb"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Currently, we are using this architecture here:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"drpM8kdY5c"}],"key":"z39JNz7T7o"}],"key":"VLkAhYwSbm"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from IPython.display import Image, display\n\ndisplay(Image(filename=\"bengio2003nn.jpeg\"))","key":"if3GMHpOZ3"},{"type":"outputs","id":"EA-BkVuxo0R460P0QXFQz","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/jpeg":{"content_type":"image/jpeg","hash":"a21abcc7498c74c85d4a3cd5f51b3817","path":"/build/a21abcc7498c74c85d4a3cd5f51b3817.jpeg"},"text/plain":{"content":"<IPython.core.display.Image object>","content_type":"text/plain"}}},"children":[],"key":"FmzkYeclTo"}],"key":"mWEbnlJDkg"}],"key":"vrSdGEarur"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"where we are taking in some number of characters, going into a single hidden layer, and then going to the prediction of the next character. The problem here is we don’t have a naive way of making this bigger in a productive way. We could, of course, use our ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bjYqQGtOcn"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UJBO1FZoMv"}],"key":"ZYE6sKkh5J"},{"type":"text","value":". We could use our layers, sort of like building block materials to introduce additional layers here and make the network deeper. But it is still the case that we are crushing all of the characters into a single layer all the way at the beginning. And even if we make this a layer bigger by adding neurons, it’s still kind of like silly to squash all that information so fast in a single step. What we’d like to do instead is we’d like our network to look a lot more like this ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QWzMUtksW6"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"WaveNet","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"EH4UJoBgii"}],"key":"ZrQlfLJ9kw"},{"type":"text","value":" case:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"G0Bx2loQCk"}],"key":"ITXlxpzSjU"}],"key":"nPSNlVWfCu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from IPython.display import Image, display\n\ndisplay(Image(filename=\"wavenet_fig3.png\"))","key":"BO1bKEbCTT"},{"type":"outputs","id":"5qCVj9x5seGe2hJRioHxE","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"198c39366ff68e8b03ccb06df349f47a","path":"/build/198c39366ff68e8b03ccb06df349f47a.png"},"text/plain":{"content":"<IPython.core.display.Image object>","content_type":"text/plain"}}},"children":[],"key":"WYfI9cbCJ8"}],"key":"aUMQPpoa0p"}],"key":"cO3dKS6rYx"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"So you see in ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YUiSI4GiYo"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"WaveNet","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WUElD58hZC"}],"key":"NPD9HmKZ3x"},{"type":"text","value":", when we are trying to make the prediction for the next character in a sequence a function of the previous characters that feed in. But it is not the case that all of these different characters are just crushed to a single layer and then you have a sandwich. They are crushed slowly. So in particular, we take two characters and we fuse them into sort of like a bigram representation. And we do that for all these characters consecutively. And then we take the bigrams and we fuse those into four character level chunks. And then we fuse again. And so we do that in this tree-like hierarchical manner. So we fuse the information from the previous context ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Nc6sOMFGrC"},{"type":"emphasis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"gradually","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xvQ1kkb3kS"}],"key":"nr1u92C9nr"},{"type":"text","value":", as the network deepens. This is the kind of architecture that we want to implement. Now in the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mI4m0Bnipu"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"WaveNet","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GgdnbtMg52"}],"key":"KuvJr80YS1"},{"type":"text","value":" case, this is a visualization of a stack of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dqig7RK9V1"},{"type":"emphasis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"dilated","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xYX7JWAgHH"}],"key":"xAeIcBMeOJ"},{"type":"text","value":" causal convolution layers. And this makes it sound very scary, but actually the idea is quite simple. And the fact that it’s a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"v71yg5OjxX"},{"type":"emphasis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"dilated","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qNAwoErhsW"}],"key":"UPjjKHIBqw"},{"type":"text","value":" causal convolution layer is really just an implementation detail to make everything fast. We’re going to see that later. But for now, let’s just keep going. We’re going to keep the basic idea of it, which is this progressive fusion. So we want to make the network deeper, and at each level, we want to fuse only two consecutive elements. Two characters, then two bigrams, then two fourgrams, and so on. So let’s implement this.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"E4uy9lFJPJ"}],"key":"nWghdghHfx"}],"key":"lHjF0gKK9m"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Bumping the context size to ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yCcX6MtK9h"},{"type":"text","value":"8","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zVcXzUfRgK"}],"identifier":"bumping-the-context-size-to-8","label":"Bumping the context size to 8","html_id":"bumping-the-context-size-to-8","implicit":true,"key":"Qty9yBYmL2"}],"key":"d55WspE4gI"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Okay, so first up, let me scroll to where we built the dataset, and let’s change the block size from ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qrHn0qWDNs"},{"type":"text","value":"3","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CkzNEstcPp"},{"type":"text","value":" to ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"G3ZomMUXyc"},{"type":"text","value":"8","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nz1ZtR6u9W"},{"type":"text","value":". So we’re going to be taking ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AmRtQEWClj"},{"type":"text","value":"8","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gY2iec6w9N"},{"type":"text","value":" characters of context to predict the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fLGj0bChos"},{"type":"inlineMath","value":"9th","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>9</mn><mi>t</mi><mi>h</mi></mrow><annotation encoding=\"application/x-tex\">9th</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord\">9</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span></span></span></span>","key":"botokvPakk"},{"type":"text","value":" character:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pbA3Lvn9th"}],"key":"xAe3d2zH9e"}],"key":"wQJ6cNt3b5"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"block_size = 8\n(xtrain, ytrain), (xval, yval), (xtest, ytest) = build_all_datasets(block_size)","key":"HIzbDGnut3"},{"type":"outputs","id":"EEmdI4TiM8CHS1aCtTCMO","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"torch.Size([182473, 8]) torch.Size([182473])\ntorch.Size([22827, 8]) torch.Size([22827])\ntorch.Size([22846, 8]) torch.Size([22846])\n"},"children":[],"key":"qfaXQ5sYle"}],"key":"dAxLaB5OBS"}],"key":"bXzf3pkIkk"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"So the dataset now looks like this:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sTSWJjTSdg"}],"key":"Nyl1vxxlbv"}],"key":"qgvWH5c5Ci"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print_next_character(xtrain[:20], ytrain[:20])","key":"FWsqdVMErO"},{"type":"outputs","id":"Y5205DsvLXWQD2xGVQXqq","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"........ --> c\n.......c --> a\n......ca --> t\n.....cat --> h\n....cath --> y\n...cathy --> .\n........ --> k\n.......k --> e\n......ke --> n\n.....ken --> a\n....kena --> d\n...kenad --> i\n..kenadi --> .\n........ --> a\n.......a --> m\n......am --> i\n.....ami --> .\n........ --> l\n.......l --> a\n......la --> r\n"},"children":[],"key":"GWLpBm1rkG"}],"key":"QtcvvyGotE"}],"key":"I20t7wk09S"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"These ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"avIM3SQIXT"},{"type":"text","value":"8","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"slTxR3gw8s"},{"type":"text","value":" characters are going to be processed in the above tree-like structure. Let’s find out how to implement this hierarchical scheme! But before doing that, let’s train our simple fully-connected ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dtxupnRE6P"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ojTCOUbuFx"}],"key":"SVH7SoZdir"},{"type":"text","value":" with this new dataset and see how well it performs:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DuoTRvMnQO"}],"key":"GoORM7xGmb"}],"key":"bnVDyJV3l6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model, parameters = define_nn(block_size, n_embd, n_hidden)\nlossi = train(xtrain, ytrain, model, parameters)","key":"QrmIIYWIEp"},{"type":"outputs","id":"Ca3xzoUv_Fw8naivDd_Tu","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"22097\n      0/ 200000: 3.3024\n  10000/ 200000: 2.1462\n  20000/ 200000: 2.2304\n  30000/ 200000: 2.1978\n  40000/ 200000: 2.3442\n  50000/ 200000: 2.1926\n  60000/ 200000: 2.4338\n  70000/ 200000: 2.0021\n  80000/ 200000: 2.0781\n  90000/ 200000: 1.7328\n 100000/ 200000: 2.2064\n 110000/ 200000: 1.9591\n 120000/ 200000: 1.9200\n 130000/ 200000: 1.7876\n 140000/ 200000: 2.0151\n 150000/ 200000: 1.9124\n 160000/ 200000: 1.9154\n 170000/ 200000: 2.4858\n 180000/ 200000: 2.0312\n 190000/ 200000: 1.7150\n"},"children":[],"key":"p3WhAVIh74"}],"key":"oOs9cPNqXt"}],"key":"gm9JxhHn6g"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"plt.figure()\nplt.plot(torch.tensor(lossi).view(-1, 1000).mean(1));","key":"d9PW6KaU1z"},{"type":"outputs","id":"d_x_fJLDsVXLbN4ZFLCC7","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"ff615d43a98747bd9c51619102571855\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"image/png":{"content_type":"image/png","hash":"165817da5ba45451a2b5cc72d6b0048c","path":"/build/165817da5ba45451a2b5cc72d6b0048c.png"},"text/html":{"content_type":"text/html","hash":"d15454142d80cffdbabe07305558aecc","path":"/build/d15454142d80cffdbabe07305558aecc.html"},"text/plain":{"content":"Canvas(toolbar=Toolbar(toolitems=[('Home', 'Reset original view', 'home', 'home'), ('Back', 'Back to previous …","content_type":"text/plain"}}},"children":[],"key":"Uvj3vTXHmC"}],"key":"uw9cMKdU0h"}],"key":"tbfyUZwjq6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"trigger_eval_mode(model)\ninfer_loss(model, xtrain, ytrain, prefix=\"train\")\ninfer_loss(model, xval, yval, prefix=\"val\");","key":"TSRJWbdTrH"},{"type":"outputs","id":"lLJUGvHvln5El0Ci8Oy0l","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"train 1.9159809350967407\nval 2.0343399047851562\n"},"children":[],"key":"UGpTqpkE09"}],"key":"C7L1OHc9BN"}],"key":"CWFhuduqQ7"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Interesting! The ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hF0I0Wbaxm"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"loss","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bG6puspEh7"}],"key":"N4intzGawH"},{"type":"text","value":" has improved compared to the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xHCddNyfUI"},{"type":"inlineCode","value":"block_size = 3","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pAQDfH8uf0"},{"type":"text","value":" case. Let’s log our losses so far:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IrdcRleGso"}],"key":"Gr07KwDTlx"}],"key":"BJ6kZK9zH9"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"code","lang":"python","value":"# original (3 character context + 200 hidden neurons, 12K params): train 2.058, val 2.105\n# context: 3 -> 8 (22K params): train 1.915, val 2.034","position":{"start":{"line":1,"column":1},"end":{"line":4,"column":1}},"key":"L5M1RvL8ZA"}],"visibility":"show","key":"QMNUXkUxRF"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Also, if we sample from the model, we can see the names improving qualitatively as well:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PDKJMcuSF1"}],"key":"jkTjEyEIXf"}],"key":"Hui8xO9Zj1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"sample_from_model(block_size, model)","key":"dQyWXc9oO2"},{"type":"outputs","id":"U3_UA8s0bQuDDyu2uK0Vw","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"kobi.\npran.\nmarlecm.\nlunghan.\ncamillo.\nshatar.\nelizee.\nlumarius.\nderis.\nbrook.\nmadaniy.\nyarel.\nmilaal.\naylen.\nnikora.\nniani.\nsahanlaa.\nelaya.\nmalixa.\ndalioluw.\n"},"children":[],"key":"C6cxGgNuK2"}],"key":"bVdq7hkhKf"}],"key":"SraZ4jD3FB"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"So we could, of course, spend a lot of time here tuning things and scaling up our network further. But let’s continue and let’s implement the hierarchical model and treat this as just a rough baseline performance. There’s a lot of optimization left on the table in terms of some of the hyperparameters that you’re hopefully getting a sense of now.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oPcpSVvZvd"}],"key":"DCbY2Zbp5r"}],"key":"vX6UeS9h8f"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Implementing ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NWtTRqNNqn"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"WaveNet","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"M8wt6uCACs"}],"key":"MGt02ZsnN9"}],"identifier":"implementing-wavenet","label":"Implementing WaveNet","html_id":"implementing-wavenet","implicit":true,"key":"ypVprcSziU"}],"visibility":"show","key":"oAfzK2unk7"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Let’s now create a bit of a scratch space for us to just look at the forward pass of the  ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"eiwYnOAytS"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"B7ocRbmc3F"}],"key":"WAjPf71Gjf"},{"type":"text","value":" and inspect the shape of the tensors along the way of the forward pass:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YA0ISDVFpd"}],"key":"tWQ8zgoPXx"}],"key":"nYNAdMAXhR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# let's look at a batch of just 4 examples\nix = torch.randint(0, xtrain.shape[0], (4,))\nxb, yb = xtrain[ix], ytrain[ix]\nlogits = model(xb)\nprint(xb.shape)\nxb","key":"rU9lsQHfbd"},{"type":"outputs","id":"ykYsm4vWMkSwiS8cY04s0","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"torch.Size([4, 8])\n"},"children":[],"key":"oviC5j60Cw"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":63,"metadata":{},"data":{"text/plain":{"content":"tensor([[ 0,  0,  0,  0,  0,  0,  0, 12],\n        [ 0,  0,  0,  0,  0,  0, 18,  5],\n        [ 0,  0,  0, 11,  1, 12,  9, 14],\n        [ 0,  0,  0,  0,  0, 11,  9, 18]])","content_type":"text/plain"}}},"children":[],"key":"cjBiuQRFFB"}],"key":"ucPrRh0zb7"}],"key":"MM8StFmDzN"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Here we are just temporarily, for debugging purposes, creating a batch of just, say, ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GlSgedUPbT"},{"type":"text","value":"4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iFfrVMi03N"},{"type":"text","value":" examples. So ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Pu7ofQIpva"},{"type":"text","value":"4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xg4Qrtj5KD"},{"type":"text","value":" random integers. Then, we are plucking out those rows from our training set. And then we are passing into the model the input ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AM8iVz96IJ"},{"type":"inlineCode","value":"xb","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rPtNbqJdXs"},{"type":"text","value":". Now the shape of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"wqc1QlHqVL"},{"type":"inlineCode","value":"xb","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ks4zxzx7J8"},{"type":"text","value":" here, because we only have ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JCAJTMcMTF"},{"type":"text","value":"4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"b2jbCR3rsR"},{"type":"text","value":" examples. And ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"r36KaLT4vC"},{"type":"text","value":"8","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bmUChNf22L"},{"type":"text","value":" is the current block size. So ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MFxqXAzGnM"},{"type":"inlineCode","value":"xb","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xdOs6ebjh2"},{"type":"text","value":" contains ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"c7egwEElbJ"},{"type":"text","value":"4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sqZyEuHYqV"},{"type":"text","value":" rows/examples of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bJ1VuTMknn"},{"type":"text","value":"8","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Bb6q0aKF8u"},{"type":"text","value":"  characters each. And each integer tensor row of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"J7shEopJ8z"},{"type":"inlineCode","value":"xb","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YkOurZFtee"},{"type":"text","value":" just contains the identities of those characters. Therefore, the first layer of our ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sYfmzRXOAE"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uO4CXrSwwI"}],"key":"EJsxgMSJTq"},{"type":"text","value":" is the embedding layer. So passing ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rbCkVVsdOD"},{"type":"inlineCode","value":"xb","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nVLg8jqpjZ"},{"type":"text","value":", this integer tensor, through the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OfU05aHS0D"},{"type":"inlineCode","value":"Embedding","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oJnYasoZuY"},{"type":"text","value":" layer creates an output:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MhuaUSh20P"}],"key":"vL6cIAPJ87"}],"key":"nhjnZ4RwbX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model.layers[0].out.shape  # output of Embedding layer","key":"y6QGU44ZeG"},{"type":"outputs","id":"mvIAzUtOJ-eQHp4Pc3h4u","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":64,"metadata":{},"data":{"text/plain":{"content":"torch.Size([4, 8, 10])","content_type":"text/plain"}}},"children":[],"key":"mBQNN2WKmX"}],"key":"uoO6SiI9sq"}],"key":"q5kIqawKhe"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"So our embedding table ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gDpPCXsNLB"},{"type":"inlineCode","value":"C","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Y4ee6d0gRf"},{"type":"text","value":" has, for each character, a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xyqautnpBi"},{"type":"text","value":"10","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Aq4y912cNX"},{"type":"text","value":"-dimensional vector (","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LaUd3XSlQV"},{"type":"inlineCode","value":"n_embd=10","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MXaCOgTyw3"},{"type":"text","value":") that we are trying to learn. What the layer does here is it plucks out the embedding vector for each one of these integers (of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kuPwAas60N"},{"type":"inlineCode","value":"xb","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yokEYH8eK8"},{"type":"text","value":" and organizes it all in a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qz956xUa1F"},{"type":"inlineMath","value":"4\\times8\\times10","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>8</mn><mo>×</mo><mn>10</mn></mrow><annotation encoding=\"application/x-tex\">4\\times8\\times10</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">8</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">10</span></span></span></span>","key":"uHAI442MsT"},{"type":"text","value":" tensor. So all of these integers are translated into ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bJNrXeudT4"},{"type":"text","value":"10","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HLDExRbBOw"},{"type":"text","value":"-dimensional vectors inside this ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qKl0fEOEjt"},{"type":"text","value":"3","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"shKfBHOZDd"},{"type":"text","value":"-dimensional tensor now.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UsIU8G3h9x"}],"key":"EAe09ZOzN8"}],"key":"al9KznEPVY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model.layers[1].out.shape  # output of Flatten layer","key":"NffHNJIuZw"},{"type":"outputs","id":"---RJI1Vz-DXci_VTSKic","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":65,"metadata":{},"data":{"text/plain":{"content":"torch.Size([4, 80])","content_type":"text/plain"}}},"children":[],"key":"RZJPwD68VC"}],"key":"K8A5jKad0z"}],"key":"uwllfmWG8J"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now passing that through the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"spAs4MnOQf"},{"type":"inlineCode","value":"Flatten","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GHjqzelU9a"},{"type":"text","value":" layer, as you recall, what this does is it views this tensor as just a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"W5NR4Z1Lup"},{"type":"inlineMath","value":"4\\times80","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>80</mn></mrow><annotation encoding=\"application/x-tex\">4\\times80</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">80</span></span></span></span>","key":"J0ZAcGBvbt"},{"type":"text","value":" tensor. And what that effectively does is that all these ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BCOaDIw8CU"},{"type":"text","value":"10","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"olDwYIjUKF"},{"type":"text","value":"-dimensional embeddings for all these ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"L4unMyszU8"},{"type":"text","value":"8","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uKovWwzH28"},{"type":"text","value":" characters just end up being stretched out into a long row. And that looks kind of like a concatenation operation, basically. So by viewing the tensor differently, we now have a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RqkJCSqd0X"},{"type":"inlineMath","value":"4\\times80","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>80</mn></mrow><annotation encoding=\"application/x-tex\">4\\times80</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">80</span></span></span></span>","key":"LT3eBr9r7C"},{"type":"text","value":". And inside this ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QpbYr34M7N"},{"type":"text","value":"80","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xFDBn5legH"},{"type":"text","value":", it’s all the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lafCRh9dRy"},{"type":"text","value":"10","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xXRJWIjJcB"},{"type":"text","value":"-dimensional vectors just concatenated next to each other.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kQD046J8DP"}],"key":"tVYhygwU8S"}],"key":"yo2rriFKwS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model.layers[2].out.shape  # output of Linear layer","key":"f6dBnkwr4j"},{"type":"outputs","id":"k4ZzIg9fxYuvOJKBmQTcT","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":66,"metadata":{},"data":{"text/plain":{"content":"torch.Size([4, 200])","content_type":"text/plain"}}},"children":[],"key":"YXNHMt8rNc"}],"key":"wb4BzYV34W"}],"key":"ZSkSk2DypD"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"And the linear layer, of course, takes ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gXklpX9aYe"},{"type":"text","value":"80","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oZ8ggzhRpR"},{"type":"text","value":" and creates ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZYI92w6yum"},{"type":"text","value":"200","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ygbWc1k8q8"},{"type":"text","value":" channels just via matrix multiplication. So far, so good. Now let’s see something surprising. Let’s look at the insides of the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"u1mcMMGXBA"},{"type":"inlineCode","value":"Linear","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fCLkz7ebao"},{"type":"text","value":" layer and remind ourselves how it works:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PwDIuILz3X"}],"key":"rAL6WaC1V3"}],"key":"gIqbksjWDJ"},{"type":"block","kind":"notebook-content","children":[{"type":"code","lang":"python","value":"class Linear:\n    def __init__(self, fan_in, fan_out, bias=True):\n        self.weight = torch.randn((fan_in, fan_out)) / fan_in**0.5\n        self.bias = torch.zeros(fan_out) if bias else None\n\n    def __call__(self, x):\n        self.out = x @ self.weight\n        if self.bias is not None:\n            self.out += self.bias\n        return self.out\n...","position":{"start":{"line":1,"column":1},"end":{"line":13,"column":1}},"key":"GFIpopVDLD"}],"key":"QrapxKBix2"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QcmL6V569q"},{"type":"inlineCode","value":"Linear","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Zw9cZ0SEgl"},{"type":"text","value":" layer here in a forward pass takes the input ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sgeZc7XABg"},{"type":"inlineCode","value":"x","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xYFWt61NYv"},{"type":"text","value":", multiplies it with a weight and then optionally adds a bias. And the weight is ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Sm3OSPoUt5"},{"type":"inlineMath","value":"2D","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">2D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord\">2</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span>","key":"zlIR2kl0nK"},{"type":"text","value":", as defined here, and the bias is ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qqLkbTO9cb"},{"type":"inlineMath","value":"1D","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">1D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord\">1</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span>","key":"M4kKib7EGf"},{"type":"text","value":". So effectively, in terms of the shapes involved, what’s happening inside this ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zqs3g8Fvau"},{"type":"inlineCode","value":"Linear","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jSne177mpV"},{"type":"text","value":" layer looks like this right now. And we’re using random numbers here, but just to illustrate the shapes and what happens:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nwPIR8Dw9Q"}],"key":"ttCvEWTWeZ"}],"key":"lpFpJ0YNQw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"(torch.randn(4, 80) @ torch.randn(80, 200) + torch.randn(200)).shape","key":"J3pZa1w5D2"},{"type":"outputs","id":"IXA0PGJKPaRLzKH1QZgv7","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":67,"metadata":{},"data":{"text/plain":{"content":"torch.Size([4, 200])","content_type":"text/plain"}}},"children":[],"key":"iTKwFHAyBr"}],"key":"gPG9fv88eH"}],"key":"bUBaT0CBYu"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Basically, a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dJuujXatBo"},{"type":"inlineMath","value":"4\\times80","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>80</mn></mrow><annotation encoding=\"application/x-tex\">4\\times80</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">80</span></span></span></span>","key":"uUZQbIsbKZ"},{"type":"text","value":" comes into the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DAeBU26WJy"},{"type":"inlineCode","value":"Linear","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fRXV8v3uI9"},{"type":"text","value":" layer, gets multiplied by a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Togdimj0NX"},{"type":"inlineMath","value":"80\\times200","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>80</mn><mo>×</mo><mn>200</mn></mrow><annotation encoding=\"application/x-tex\">80\\times200</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">80</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">200</span></span></span></span>","key":"Q5wS7OUI5u"},{"type":"text","value":" weight matrix inside, and then there’s a plus ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DkPjULja6q"},{"type":"text","value":"200","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qu52nokNxd"},{"type":"text","value":" bias. And the shape of the whole thing that comes out of the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WnXoj8fnaz"},{"type":"inlineCode","value":"Linear","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rWt1EvpU8G"},{"type":"text","value":" layer is ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FNAtQCgTu6"},{"type":"inlineMath","value":"4\\times200","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>200</mn></mrow><annotation encoding=\"application/x-tex\">4\\times200</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">200</span></span></span></span>","key":"xcgpPT6A5Q"},{"type":"text","value":", as we see here. Notice, by the way, that the matrix multiplication here will create a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"T215YguZhh"},{"type":"inlineMath","value":"4x200","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mi>x</mi><mn>200</mn></mrow><annotation encoding=\"application/x-tex\">4x200</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">4</span><span class=\"mord mathnormal\">x</span><span class=\"mord\">200</span></span></span></span>","key":"gmXVQFawQr"},{"type":"text","value":" tensor, and then when adding ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WjRpPA2kBm"},{"type":"text","value":"200","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AkLu8alnea"},{"type":"text","value":" there’s a broadcasting happening here, but since ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"eUUWLX0JFQ"},{"type":"inlineMath","value":"4x200","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mi>x</mi><mn>200</mn></mrow><annotation encoding=\"application/x-tex\">4x200</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">4</span><span class=\"mord mathnormal\">x</span><span class=\"mord\">200</span></span></span></span>","key":"RQxcerhG6F"},{"type":"text","value":" broadcasts with ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CVE0QVHJjb"},{"type":"text","value":"200","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ESkmqI0zM0"},{"type":"text","value":", everything works here. So now the surprising thing is how this works. Specifically, something you may not expect is that this input here, that is being matrix-multiplied, doesn’t actually have to be ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"i4SZbZ1FDY"},{"type":"inlineMath","value":"2D","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">2D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord\">2</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span>","key":"qiJ3mjmJQl"},{"type":"text","value":". This matrix multiply operator in ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Gh9cIJwKqa"},{"type":"inlineCode","value":"PyTorch","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"n182m3R1bk"},{"type":"text","value":" is quite powerful, and in fact, you can actually pass in higher dimensional arrays or tensors, and everything works fine. So for example, ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fMRJErgRk0"},{"type":"inlineCode","value":"torch.randn(4, 80)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BRlQVR5Kgu"},{"type":"text","value":" could instead be ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"q08bhWLKy9"},{"type":"inlineCode","value":"torch.randn(4, 5, 80)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aJ3hlpLDnb"},{"type":"text","value":" (","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IaTiS6ORTn"},{"type":"inlineMath","value":"4\\times5\\times80","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>5</mn><mo>×</mo><mn>80</mn></mrow><annotation encoding=\"application/x-tex\">4\\times5\\times80</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">80</span></span></span></span>","key":"IOdrkKysnr"},{"type":"text","value":") and the result in that case would become ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"r4n6dBYZk5"},{"type":"inlineMath","value":"4\\times5\\times200","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>5</mn><mo>×</mo><mn>200</mn></mrow><annotation encoding=\"application/x-tex\">4\\times5\\times200</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">5</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">200</span></span></span></span>","key":"ag8A2dtY9a"},{"type":"text","value":". You can add as many dimensions as you like to the left of the last dimension of the input tensor (here, dimension ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"w5Lbg0VdVX"},{"type":"text","value":"80","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BQcukPkhzz"},{"type":"text","value":"). And so effectively, what’s happening is that the matrix multiplication only works on a matrix multiplication on the last dimension, and the dimensions before it in the input tensor are left unchanged. So basically, these dimensions to the left of the last dimension are all treated as just a batch dimension. So we can have multiple batch dimensions (e.g. ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rSiQBHWdOy"},{"type":"inlineCode","value":"torch.randn(4, 5, 6, 7, 80)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tlfoSvSZqV"},{"type":"text","value":"), and then in parallel over all those dimensions, we are doing the matrix multiplication only on the last dimension. So this is quite convenient, because we can use that in our ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xoKUHjFHxI"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qw0sPqOnVC"}],"key":"CagoskHIIs"},{"type":"text","value":" now. Remember that we have these ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XWcJmq5I92"},{"type":"text","value":"8","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dhAUjnF0be"},{"type":"text","value":" characters coming in, e.g.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MZCxvijJoz"}],"key":"plHp5nuSH9"},{"type":"code","lang":"python","value":"# 1 2 3 4 5 6 7 8","position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"key":"vBky81FzE6"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"And we don’t want to now flatten all of it out into a large ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"iZxoPPn2aS"},{"type":"text","value":"8","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"cGNzGGIPBB"},{"type":"text","value":"-dimensional vector, because we don’t want to matrix multiply ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"kr6K0WE0nl"},{"type":"text","value":"80","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Fp9TYeZ3By"},{"type":"text","value":" into a weight matrix multiply immediately. Instead, we want to group these like this:","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"jlzErUknhA"}],"key":"KaGEK1bHJN"},{"type":"code","lang":"python","value":"# (1 2) (3 4) (5 6) (7 8)","position":{"start":{"line":9,"column":1},"end":{"line":11,"column":1}},"key":"XNpBwfFOAr"},{"type":"paragraph","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"So every consecutive two elements should now basically be flattened and multiplied by a weight matrix. But the idea is that all of these four groups here, we’d like to process in parallel. So it’s kind of like a extra batch dimension that we can introduce. And then we can, in parallel, basically process all of these bigram groups in the four extra batch dimension of an individual example, and also over the actual batch dimension of the four examples. So let’s see what this is all about and how that works. Right now, we take a ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"xLXPB2XZhr"},{"type":"inlineMath","value":"4\\times80","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>80</mn></mrow><annotation encoding=\"application/x-tex\">4\\times80</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">80</span></span></span></span>","key":"b9ntbBFeGl"},{"type":"text","value":" and multiply it by ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"qxxklk9ihl"},{"type":"inlineMath","value":"80\\times200","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>80</mn><mo>×</mo><mn>200</mn></mrow><annotation encoding=\"application/x-tex\">80\\times200</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">80</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">200</span></span></span></span>","key":"T3ZFulMQOT"},{"type":"text","value":" in the linear layer. Effectively, what we want is instead of ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"zX3DfPvJ0g"},{"type":"text","value":"8","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"Etf4FUVIMH"},{"type":"text","value":" characters (","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"jMwtuPmCDx"},{"type":"text","value":"80","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"EXIc5QdiI3"},{"type":"text","value":" embedding numbers) coming in, we only want ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"V3oBhJECFf"},{"type":"text","value":"2","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"ihAvAql4iw"},{"type":"text","value":" characters (","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"W1YWo4TWfD"},{"type":"text","value":"20","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"pMH2C5phm2"},{"type":"text","value":" embedding numbers) to come in. Therefore, if we want that, we can’t have a ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"nrPtLJTZkZ"},{"type":"inlineMath","value":"4x80","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mi>x</mi><mn>80</mn></mrow><annotation encoding=\"application/x-tex\">4x80</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">4</span><span class=\"mord mathnormal\">x</span><span class=\"mord\">80</span></span></span></span>","key":"aDwaWJ43pE"},{"type":"text","value":" feeding into the ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"g41e4lmw2v"},{"type":"inlineCode","value":"Linear","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"oZKk6sndbx"},{"type":"text","value":" layer, but instead ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"DeAztP4IXJ"},{"type":"text","value":"4","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"noD9U3se1F"},{"type":"text","value":" groups of ","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"M0CoOmva11"},{"type":"text","value":"2","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"o9wk00rUEe"},{"type":"text","value":" characters to be feeding in, like this:","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"wGCs96wHS2"}],"key":"NpoiDlnG6C"}],"key":"wVyae8woRQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"(torch.randn(4, 4, 20) @ torch.randn(20, 200) + torch.randn(200)).shape","key":"FG29QvGvAd"},{"type":"outputs","id":"eXV1eGUSreY8L8HHtFkbZ","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":68,"metadata":{},"data":{"text/plain":{"content":"torch.Size([4, 4, 200])","content_type":"text/plain"}}},"children":[],"key":"lLl9zBGUBX"}],"key":"iVokjmlLP7"}],"key":"qPdjrQTIRJ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Therefore, what we would want to do now is change the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"d2dijZVQFn"},{"type":"inlineCode","value":"Flatten","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"P8bwTnE3ha"},{"type":"text","value":" layer so that it doesn’t output a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Jlb3vDNNNV"},{"type":"inlineMath","value":"4x80","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mi>x</mi><mn>80</mn></mrow><annotation encoding=\"application/x-tex\">4x80</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">4</span><span class=\"mord mathnormal\">x</span><span class=\"mord\">80</span></span></span></span>","key":"QifZ2zwaig"},{"type":"text","value":" but a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WC1yZdY7EN"},{"type":"inlineMath","value":"4x4x20","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mi>x</mi><mn>4</mn><mi>x</mi><mn>20</mn></mrow><annotation encoding=\"application/x-tex\">4x4x20</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">4</span><span class=\"mord mathnormal\">x</span><span class=\"mord\">4</span><span class=\"mord mathnormal\">x</span><span class=\"mord\">20</span></span></span></span>","key":"UxanUbLx4e"},{"type":"text","value":" where basically in each row tensor of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"w2oQIW1q8h"},{"type":"inlineCode","value":"xb","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"f8eNAYgHxv"},{"type":"text","value":":","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TxivP5e96z"}],"key":"Y2UP5oTHT6"}],"key":"fI9WHOk40J"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"xb","key":"Ar1Ms7cycw"},{"type":"outputs","id":"2IsibzXhTC9S_a88ZbJFl","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":69,"metadata":{},"data":{"text/plain":{"content":"tensor([[ 0,  0,  0,  0,  0,  0,  0, 12],\n        [ 0,  0,  0,  0,  0,  0, 18,  5],\n        [ 0,  0,  0, 11,  1, 12,  9, 14],\n        [ 0,  0,  0,  0,  0, 11,  9, 18]])","content_type":"text/plain"}}},"children":[],"key":"esl2xw0m0l"}],"key":"aE5R9TTDms"}],"key":"iUlr3sHSAn"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"every two consecutive characters (e.g. ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"umbpTaYTra"},{"type":"inlineMath","value":"(0, 0), (10, 21), (12,  9), (5, 1)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mn>0</mn><mo separator=\"true\">,</mo><mn>0</mn><mo stretchy=\"false\">)</mo><mo separator=\"true\">,</mo><mo stretchy=\"false\">(</mo><mn>10</mn><mo separator=\"true\">,</mo><mn>21</mn><mo stretchy=\"false\">)</mo><mo separator=\"true\">,</mo><mo stretchy=\"false\">(</mo><mn>12</mn><mo separator=\"true\">,</mo><mn>9</mn><mo stretchy=\"false\">)</mo><mo separator=\"true\">,</mo><mo stretchy=\"false\">(</mo><mn>5</mn><mo separator=\"true\">,</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(0, 0), (10, 21), (12,  9), (5, 1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">0</span><span class=\"mclose\">)</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">10</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">21</span><span class=\"mclose\">)</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">12</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">9</span><span class=\"mclose\">)</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">5</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span></span></span>","key":"XQIKIBaT03"},{"type":"text","value":") are packed in on the very last dimension (i.e. ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nPzhHXL1wx"},{"type":"text","value":"20","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qOBaTBlerS"},{"type":"text","value":"). So that the first dimension (i.e. ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aW81IUd7K5"},{"type":"text","value":"4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"c0FWp73oFK"},{"type":"text","value":") is the first batch dimension and the second dimension (i.e. ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"em9KrvmPNG"},{"type":"text","value":"4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ijflavTHg5"},{"type":"text","value":") is the second batch dimension. And this is where we want to get to:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oEzsJ457cM"}],"key":"yZp8yqBe4e"}],"key":"HJeaLFvJUo"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"(torch.randn(4, 4, 20) @ torch.randn(20, 200) + torch.randn(200)).shape","key":"lCg2EZgtaE"},{"type":"outputs","id":"cqlaUO2GporOJRJ0nsG0v","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":70,"metadata":{},"data":{"text/plain":{"content":"torch.Size([4, 4, 200])","content_type":"text/plain"}}},"children":[],"key":"P7u9peQnlA"}],"key":"gPbxK4pe5J"}],"key":"REKpEb3Yqh"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now we have to change our ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YzxRuJxJlG"},{"type":"inlineCode","value":"Flatten","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pZU3yjZHMN"},{"type":"text","value":" layer (so that it doesn’t fully flatten out the examples, but creates a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"szsWqGVL0F"},{"type":"inlineMath","value":"4\\times4\\times20","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>4</mn><mo>×</mo><mn>20</mn></mrow><annotation encoding=\"application/x-tex\">4\\times4\\times20</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">20</span></span></span></span>","key":"U4fyDTzCIT"},{"type":"text","value":" instead of a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZjZKsKIGyt"},{"type":"inlineMath","value":"4\\times80","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>80</mn></mrow><annotation encoding=\"application/x-tex\">4\\times80</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">80</span></span></span></span>","key":"UBzpJgmazW"},{"type":"text","value":") and our ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yLedEWswIj"},{"type":"inlineCode","value":"Linear","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ls0OGajsnk"},{"type":"text","value":" layer (to expect ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gjJrUzvvhz"},{"type":"text","value":"20","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"x2cn6aZurN"},{"type":"text","value":" instead of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OKscgxVhOq"},{"type":"text","value":"80","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rZbRIHFG0W"},{"type":"text","value":"). So let’s see how this could be implemented. Basically, right now we have an input that is a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NoI4BApGEc"},{"type":"inlineMath","value":"4\\times8\\times10","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>8</mn><mo>×</mo><mn>10</mn></mrow><annotation encoding=\"application/x-tex\">4\\times8\\times10</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">8</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">10</span></span></span></span>","key":"vy06XiPuN8"},{"type":"text","value":" that feeds into the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GFV0W3LfHZ"},{"type":"inlineCode","value":"Flatten","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WrSPk6tGmb"},{"type":"text","value":" layer, and currently the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"wqDaVXXKkS"},{"type":"inlineCode","value":"Flatten","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LWOdWpv51H"},{"type":"text","value":" layer just stretches it out:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MJbe5Z03XD"}],"key":"LtZcDtUZCc"},{"type":"code","lang":"python","value":"class Flatten:\n    def __call__(self, x):\n        self.out = x.view(x.shape[0], -1)\n        return self.out\n...","position":{"start":{"line":3,"column":1},"end":{"line":9,"column":1}},"key":"uyIWpQtS36"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"through the ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"UlcSAb5xHz"},{"type":"inlineCode","value":"view","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"e12rBCYnyr"},{"type":"text","value":" operation. Effectively what it does now is:","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"g7Yvgy9oPM"}],"key":"cisEZaSIdk"}],"key":"ZMV2owulRO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"e = torch.randn(\n    4, 8, 10\n)  # goal: want this to be (4, 4, 20) where consecutive 10-d vectors get concatenated\ne.view(4, -1).shape  # yields 4x80","key":"voFdYKCk4s"},{"type":"outputs","id":"PBJlBOU_JpNxEiOnUDjPB","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":71,"metadata":{},"data":{"text/plain":{"content":"torch.Size([4, 80])","content_type":"text/plain"}}},"children":[],"key":"gVddArG95o"}],"key":"cOsJROGI3y"}],"key":"G4mg53YoZ1"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"But we want to just view the same tensor as a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"amcyRbe4T7"},{"type":"inlineMath","value":"4x4x20","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mi>x</mi><mn>4</mn><mi>x</mi><mn>20</mn></mrow><annotation encoding=\"application/x-tex\">4x4x20</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">4</span><span class=\"mord mathnormal\">x</span><span class=\"mord\">4</span><span class=\"mord mathnormal\">x</span><span class=\"mord\">20</span></span></span></span>","key":"cswYw8vGwq"},{"type":"text","value":" instead, so:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AGhenNVHFv"}],"key":"sSR2WuEPd5"}],"key":"lrH6Pr71UR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"e.view(4, 4, -1).shape  # yields 4x4x20: this is what we want!","key":"ug1P5otO54"},{"type":"outputs","id":"AikTl-tCfwgqjt9iwn7Zw","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":72,"metadata":{},"data":{"text/plain":{"content":"torch.Size([4, 4, 20])","content_type":"text/plain"}}},"children":[],"key":"X9mZ1Jewb6"}],"key":"CkiFun5ArB"}],"key":"f38uTZH2Zx"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Easy, right? Let’s now rewrite ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"C0zY4wm1YV"},{"type":"inlineCode","value":"Flatten","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yHQZztc0r7"},{"type":"text","value":", but since ours will now start to depart from ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"B4XM4lJ2WR"},{"type":"link","url":"https://pytorch.org/docs/stable/generated/torch.nn.Flatten.html#torch.nn.Flatten","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"inlineCode","value":"torch.nn.Flatten","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UZvkEZFVuj"}],"urlSource":"https://pytorch.org/docs/stable/generated/torch.nn.Flatten.html#torch.nn.Flatten","key":"BUqUe9J6kc"},{"type":"text","value":", we’ll rename it to ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vpMOvJp8VW"},{"type":"inlineCode","value":"FlattenConsecutive","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"c8jHiYsioa"},{"type":"text","value":" just to make sure that our APIs are somewhat similar but not the same:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AKCfASSStM"}],"key":"ikj1GahmKj"}],"key":"SPVbecoYzB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"class FlattenConsecutive:\n    def __init__(self, n):\n        self.n = n\n\n    def __call__(self, x):\n        b, t, c = x.shape\n        x = x.view(b, t // self.n, c * self.n)\n        if x.shape[1] == 1:\n            x = x.squeeze(1)\n        self.out = x\n        return self.out\n\n    def parameters(self):\n        return []","key":"XfUhOZNnhb"},{"type":"outputs","id":"mwYeUNC_KDoz2rqwcRpJo","children":[],"key":"DEy7QHQ6Dc"}],"key":"p0K7lDo5wI"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"So ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WP9n00IZKg"},{"type":"inlineCode","value":"FlattenConsecutive","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZSK7LU7Y6Z"},{"type":"text","value":" takes in and flattens only some ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"eWaOQYgjZK"},{"type":"inlineCode","value":"n","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HaIO2ZsgGK"},{"type":"text","value":" consecutive elements and puts them into the last dimension. In ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"G6zcMbpL80"},{"type":"inlineCode","value":"__call__","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tq2Xgo6iRU"},{"type":"text","value":" we parse the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SdSnNype1s"},{"type":"text","value":"3","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gM4Nn7SYAN"},{"type":"text","value":" dimensions of the input ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cZzYDdMrph"},{"type":"inlineCode","value":"x","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GsrwXVAgql"},{"type":"text","value":" as ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SR2M1ouoad"},{"type":"inlineCode","value":"b","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PDh6wPE8V3"},{"type":"text","value":", ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"f7kURdh90X"},{"type":"inlineCode","value":"c","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YP8H6z2NpE"},{"type":"text","value":", ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"d8XAGi7wbS"},{"type":"inlineCode","value":"t","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"I7rnFo8AkZ"},{"type":"text","value":" (e.g. ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BQJ1Coc3HE"},{"type":"text","value":"4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Oeh1DBYsLL"},{"type":"text","value":", ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jWgXUnXdLv"},{"type":"text","value":"8","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"adephJyEyt"},{"type":"text","value":", ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VNLgsQRycq"},{"type":"text","value":"10","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sVAudzPMWs"},{"type":"text","value":") and then we view ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LTL5ZVYRt2"},{"type":"inlineCode","value":"x","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"P46c6btOpY"},{"type":"text","value":" as a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"J8PXuyI3bR"},{"type":"inlineCode","value":"b","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OpQFWHiLX9"},{"type":"text","value":", ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gCBV7TPxTm"},{"type":"inlineCode","value":"t // n","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"J3v8OkrHs0"},{"type":"text","value":", ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qlr8XVYOHJ"},{"type":"inlineCode","value":"c * n","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OCSfbRZskI"},{"type":"text","value":" tensor (e.g. ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"u0iWSnv5OX"},{"type":"text","value":"4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LWV1bCgg0a"},{"type":"text","value":", ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BEKGC4pkW2"},{"type":"inlineMath","value":"8/2","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>8</mn><mi mathvariant=\"normal\">/</mi><mn>2</mn></mrow><annotation encoding=\"application/x-tex\">8/2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">8/2</span></span></span></span>","key":"Grm0kDxgzM"},{"type":"text","value":", ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"x8QgWSb7js"},{"type":"inlineMath","value":"10 \\cdot 2","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>10</mn><mo>⋅</mo><mn>2</mn></mrow><annotation encoding=\"application/x-tex\">10 \\cdot 2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">10</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⋅</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">2</span></span></span></span>","key":"YFjqRO6M4N"},{"type":"text","value":", ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"R71k9RpXVi"},{"type":"emphasis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"a.k.a.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KLofp73E9e"}],"key":"OMcyYwEbmK"},{"type":"text","value":": ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mZid5KSRXf"},{"type":"text","value":"4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Qvi5jZx41S"},{"type":"text","value":", ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UCbIu4VQKX"},{"type":"text","value":"4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GVkFXF5Apw"},{"type":"text","value":", ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NRuzRirzKe"},{"type":"text","value":"20","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PSwT0ifqD0"},{"type":"text","value":"). Last but not least, we check whether the middle dimension of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ME09H78WkH"},{"type":"inlineCode","value":"x","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pwMruDgWak"},{"type":"text","value":" (","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zZOhVOAMm1"},{"type":"inlineCode","value":"x.shape[1]","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"eD2xBq7pc5"},{"type":"text","value":") is ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"k7YjUdyFN0"},{"type":"text","value":"1","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"wluj6f8efE"},{"type":"text","value":" and if so, then we simply squeeze out that dimension (e.g. ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sHn6oCxphE"},{"type":"inlineMath","value":"4\\times1\\times10","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>1</mn><mo>×</mo><mn>10</mn></mrow><annotation encoding=\"application/x-tex\">4\\times1\\times10</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">10</span></span></span></span>","key":"ji8gI7OLRk"},{"type":"text","value":" would become ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"wdpwu6PsZi"},{"type":"inlineMath","value":"4\\times10","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>10</mn></mrow><annotation encoding=\"application/x-tex\">4\\times10</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">10</span></span></span></span>","key":"UFf7wvwArU"},{"type":"text","value":"). Let’s now replace ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TJSX8aa7qX"},{"type":"inlineCode","value":"Flatten","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rX4eSgq0hC"},{"type":"text","value":" with our new ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QEYpCStp6c"},{"type":"inlineCode","value":"FlattenConsecutive","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"k3pb7WJ4P0"},{"type":"text","value":", while maintaining the same functionality:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qP81pZgNRS"}],"key":"L8n1hHZfWv"}],"key":"eWbaqmQOId"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def define_nn(block_size, n_embd, n_hidden):\n    n_inputs = n_embd * block_size\n    n_outputs = vocab_size\n    model = Sequential(\n        [\n            Embedding(vocab_size, n_embd),\n            FlattenConsecutive(block_size),\n            Linear(n_inputs, n_hidden, bias=False),\n            BatchNorm1d(n_hidden),\n            Tanh(),\n            Linear(n_hidden, n_outputs),\n        ]\n    )\n    # parameter init\n    with torch.no_grad():\n        model.layers[-1].weight *= 0.1  # last layer make less confident\n    parameters = model.parameters()\n    print(sum(p.nelement() for p in parameters))  # number of parameters in total\n    for p in parameters:\n        p.requires_grad = True\n    return model, parameters","key":"iR3Xp1DDuG"},{"type":"outputs","id":"990QdvgjmPBCCUl4sKJIq","children":[],"key":"gocSOyfiFl"}],"key":"ZvYaTEZ1XU"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now, let’s define the model and verify that the shapes of the layer outputs are the same after feeding one batch of data into it:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SydOZiIntA"}],"key":"e7ET0w4xNy"}],"key":"OKDteSEc91"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model, _ = define_nn(block_size, n_embd, n_hidden)\nprint(xb.shape)\nmodel(xb)\nfor l in model.layers:\n    print(l.__class__.__name__, \":\", tuple(l.out.shape))","key":"Xoubn4cGRc"},{"type":"outputs","id":"961EzqLWLqmo_YZRWyIgy","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"22097\ntorch.Size([4, 8])\nEmbedding : (4, 8, 10)\nFlattenConsecutive : (4, 80)\nLinear : (4, 200)\nBatchNorm1d : (4, 200)\nTanh : (4, 200)\nLinear : (4, 27)\n"},"children":[],"key":"hRzcyV3omA"}],"key":"Pi5LuoMwl6"}],"key":"iBWLSvuuxO"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"So, we see the shapes as we expect them after every single layer in its output. Now, let’s try to restructure it and do it hierarchically:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"V1XiJjY44P"}],"key":"LyloMLz4Vj"}],"key":"h7urUMcu7z"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def define_nn(block_size, n_embd, n_hidden):\n    n_consec = 2\n    n_inputs = n_embd * n_consec\n    n_outputs = vocab_size\n    model = Sequential(\n        [\n            Embedding(vocab_size, n_embd),\n            FlattenConsecutive(n_consec),\n            Linear(n_inputs, n_hidden, bias=False),\n            BatchNorm1d(n_hidden),\n            Tanh(),\n            FlattenConsecutive(n_consec),\n            Linear(n_hidden * n_consec, n_hidden, bias=False),\n            BatchNorm1d(n_hidden),\n            Tanh(),\n            FlattenConsecutive(n_consec),\n            Linear(n_hidden * n_consec, n_hidden, bias=False),\n            BatchNorm1d(n_hidden),\n            Tanh(),\n            Linear(n_hidden, n_outputs),\n        ]\n    )\n    # parameter init\n    with torch.no_grad():\n        model.layers[-1].weight *= 0.1  # last layer make less confident\n    parameters = model.parameters()\n    print(sum(p.nelement() for p in parameters))  # number of parameters in total\n    for p in parameters:\n        p.requires_grad = True\n    return model, parameters","key":"uLOgvVZpIv"},{"type":"outputs","id":"3jPxGCE_0Qhx5DkExbclL","children":[],"key":"wmIsPJV2Re"}],"key":"Cq2p8mIkGw"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now, let’s inspect the numbers in between after a forward pass on a new ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RbVBEiLJGH"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GgtpJ2nSLX"}],"key":"Q4jOVwJSCr"},{"type":"text","value":":","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PLRzT2XIFr"}],"key":"puMKIg8VSw"}],"key":"eJUZNTpvB5"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model, _ = define_nn(block_size, n_embd, n_hidden)\nprint(xb.shape)\nmodel(xb)\nfor l in model.layers:\n    print(l.__class__.__name__, \":\", tuple(l.out.shape))","key":"gpWktbSLWz"},{"type":"outputs","id":"2uolD8tk3LkhtYZBS0Yu2","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"170897\ntorch.Size([4, 8])\nEmbedding : (4, 8, 10)\nFlattenConsecutive : (4, 4, 20)\nLinear : (4, 4, 200)\nBatchNorm1d : (4, 4, 200)\nTanh : (4, 4, 200)\nFlattenConsecutive : (4, 2, 400)\nLinear : (4, 2, 200)\nBatchNorm1d : (4, 2, 200)\nTanh : (4, 2, 200)\nFlattenConsecutive : (4, 400)\nLinear : (4, 200)\nBatchNorm1d : (4, 200)\nTanh : (4, 200)\nLinear : (4, 27)\n"},"children":[],"key":"WBP8TrhkwP"}],"key":"YgSKV3B1UO"}],"key":"DpDAvuUoZZ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"So ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VkifRGdg6p"},{"type":"inlineMath","value":"4\\times8\\times20","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>8</mn><mo>×</mo><mn>20</mn></mrow><annotation encoding=\"application/x-tex\">4\\times8\\times20</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">8</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">20</span></span></span></span>","key":"AEpsEe0mpV"},{"type":"text","value":" was flattened consecutively into ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oeWYzFeUTa"},{"type":"inlineMath","value":"4\\times4\\times20","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>4</mn><mo>×</mo><mn>20</mn></mrow><annotation encoding=\"application/x-tex\">4\\times4\\times20</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">20</span></span></span></span>","key":"rVA1ayutsK"},{"type":"text","value":". Through the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Qi62BMUVpk"},{"type":"inlineCode","value":"Linear","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ge32CIajWU"},{"type":"text","value":" layer, this was projected into ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SAcUABGPXU"},{"type":"inlineMath","value":"4\\times4\\times200","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>4</mn><mo>×</mo><mn>200</mn></mrow><annotation encoding=\"application/x-tex\">4\\times4\\times200</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">200</span></span></span></span>","key":"MjkZQSsuEn"},{"type":"text","value":". And then ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WWuOI8fPt1"},{"type":"inlineCode","value":"BatchNorm1d","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"H0Bp0kj9Vx"},{"type":"text","value":" just works out of the box and so does ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yht6spYCEv"},{"type":"inlineCode","value":"Tanh","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Xm3418E3ov"},{"type":"text","value":", which is element-wise. Then we crushed it again. So we flattened consecutively once more and ended up with a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Q0tr4kxN9b"},{"type":"inlineMath","value":"4\\times2\\times400","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>2</mn><mo>×</mo><mn>400</mn></mrow><annotation encoding=\"application/x-tex\">4\\times2\\times400</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">400</span></span></span></span>","key":"nkBJl76fsO"},{"type":"text","value":" now. Then ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OWDoALwKMl"},{"type":"inlineCode","value":"Linear","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mZPruxvbrH"},{"type":"text","value":" brought it back down to ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VvIAj0uIfk"},{"type":"inlineMath","value":"4\\times2\\times200","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>2</mn><mo>×</mo><mn>200</mn></mrow><annotation encoding=\"application/x-tex\">4\\times2\\times200</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">2</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">200</span></span></span></span>","key":"VNLI8DB8j8"},{"type":"text","value":", ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nrxsEe4S2c"},{"type":"inlineCode","value":"BatchNorm1d","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZpwnNEVFt2"},{"type":"text","value":" and ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TK5jbb1dNQ"},{"type":"inlineCode","value":"Tanh","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iah6Qt42E3"},{"type":"text","value":" didn’t change the shape and for the last flattening,\nit squeezed out that dimension of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"V6KXZvxf5q"},{"type":"text","value":"1","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LMxTDVd6ZY"},{"type":"text","value":", we end up with ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zMsaydwLzt"},{"type":"inlineMath","value":"4\\times400","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>400</mn></mrow><annotation encoding=\"application/x-tex\">4\\times400</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">400</span></span></span></span>","key":"H0XSVlDIbf"},{"type":"text","value":". And then ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"h3mF6Ok0dC"},{"type":"inlineCode","value":"Linear","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KLVb5y8zVx"},{"type":"text","value":", ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jF0pLEGiEh"},{"type":"inlineCode","value":"BatchNorm1d","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"neCB8pAt7e"},{"type":"text","value":", ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ty6DlW0twy"},{"type":"inlineCode","value":"Tanh","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rxAdRNbi2b"},{"type":"text","value":" and the last ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"L5MQCfJoKE"},{"type":"inlineCode","value":"Linear","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UUntho8X7z"},{"type":"text","value":" yield our logits that end up in the same shape as they were before. Now, we actually have a nice three-layer ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"n1QcKx7sAQ"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rWudW5aHbe"}],"key":"WLbO0zZIn4"},{"type":"text","value":" that basically corresponds to this ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TvdsyUzhSc"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"WaveNet","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"eNPRhvtdYc"}],"key":"nbGRbrjqHu"},{"type":"text","value":" network:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xYrT3YATYP"}],"key":"Q4B61iOPbw"}],"key":"wTKFAUnpTs"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from IPython.display import Image, display\n\ndisplay(Image(filename=\"wavenet_fig3.png\"))","key":"IylwwUNxyx"},{"type":"outputs","id":"Sn-FRahIZo2iXl97nWVDZ","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"198c39366ff68e8b03ccb06df349f47a","path":"/build/198c39366ff68e8b03ccb06df349f47a.png"},"text/plain":{"content":"<IPython.core.display.Image object>","content_type":"text/plain"}}},"children":[],"key":"sE3g2pEimX"}],"key":"U9jfQhakox"}],"key":"kJsDprGgtU"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"with the only difference that we are using a blocksize of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aSq6BpEqAj"},{"type":"text","value":"8","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nnMt705bYk"},{"type":"text","value":" instead of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"x1h8D5Ll2t"},{"type":"text","value":"16","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oEVNa9mRY1"},{"type":"text","value":", as depicted above. Now with a new architecture, we just have to kind of figure out some good channel numbers (numbers of hidden units) to use here. If we decrease the number to:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VCJ2q80yDp"}],"key":"WPcipKzxHS"}],"key":"rcfZKLgfNo"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"n_hidden = 68","key":"ymPbxgAVyc"},{"type":"outputs","id":"EHPp0nQLyjPvb8Sbdhu-l","children":[],"key":"O8awKSXBRL"}],"key":"bbsgWwcPHD"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"then the total number of parameters comes out to ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PPPPsvC6M3"},{"type":"text","value":"22000","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Nllkm7X2CR"},{"type":"text","value":": exactly the same that we had before (when ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FwngN0t6xa"},{"type":"inlineCode","value":"n_hidden=200","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HpxgXRhgiT"},{"type":"text","value":"). So we have the same amount of capacity with this ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uyHaP5YXjv"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VwZRhyOjEZ"}],"key":"KkbRU5pOP2"},{"type":"text","value":" in terms of the number of parameters. But the question is whether we are utilizing those parameters in a more efficient architecture.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YMsnnpNyfS"}],"key":"NMbHGKcmcI"}],"key":"xLlE1KZw9O"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Training the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cUoVM0kmX6"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"WaveNet","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NAqmOJwzqT"}],"key":"hH8QoBeitz"},{"type":"text","value":": first pass","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Vnn8COoUlk"}],"identifier":"training-the-wavenet-first-pass","label":"Training the WaveNet: first pass","html_id":"training-the-wavenet-first-pass","implicit":true,"key":"e171X25MNX"}],"visibility":"show","key":"HT7dg1JBuw"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Let’s train this ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YLALpvLpma"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"WaveNet","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kIQl9onbqT"}],"key":"BKdS51hGqu"},{"type":"text","value":" and see the results:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AGg6gmmXQJ"}],"key":"zzO0wijDSW"}],"key":"N4mpoXisM3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model, parameters = define_nn(block_size, n_embd, n_hidden)\nlossi = train(xtrain, ytrain, model, parameters)","key":"QEbw6waVjn"},{"type":"outputs","id":"imqcmuzBqdRliNWbtxfhr","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"22397\n      0/ 200000: 3.2978\n  10000/ 200000: 2.1271\n  20000/ 200000: 2.0807\n  30000/ 200000: 1.6842\n  40000/ 200000: 2.0252\n  50000/ 200000: 2.3853\n  60000/ 200000: 2.4678\n  70000/ 200000: 1.7907\n  80000/ 200000: 2.2092\n  90000/ 200000: 2.3790\n 100000/ 200000: 1.7643\n 110000/ 200000: 1.6553\n 120000/ 200000: 1.9414\n 130000/ 200000: 1.9827\n 140000/ 200000: 1.7703\n 150000/ 200000: 1.8300\n 160000/ 200000: 1.6640\n 170000/ 200000: 1.9619\n 180000/ 200000: 1.7971\n 190000/ 200000: 1.9981\n"},"children":[],"key":"AQY1CSLifh"}],"key":"N8gqk7p1pb"}],"key":"kgrYU3E8Ps"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"plt.figure()\nplt.plot(torch.tensor(lossi).view(-1, 1000).mean(1));","key":"fQsdR5jsDF"},{"type":"outputs","id":"H5j-qXxrYb9nz7KQlBf4Z","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"ebbb1fbb33064be7876271d293fca166\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"image/png":{"content_type":"image/png","hash":"cf9b940575805b57c2be2a06f27ba028","path":"/build/cf9b940575805b57c2be2a06f27ba028.png"},"text/html":{"content_type":"text/html","hash":"ed8a713dd897205bb2b423de5d813551","path":"/build/ed8a713dd897205bb2b423de5d813551.html"},"text/plain":{"content":"Canvas(toolbar=Toolbar(toolitems=[('Home', 'Reset original view', 'home', 'home'), ('Back', 'Back to previous …","content_type":"text/plain"}}},"children":[],"key":"qrBehSes8D"}],"key":"A1lZA4uNlB"}],"key":"CjuwnNqwG8"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"trigger_eval_mode(model)\ninfer_loss(model, xtrain, ytrain, prefix=\"train\")\ninfer_loss(model, xval, yval, prefix=\"val\");","key":"d1NGmM4LYB"},{"type":"outputs","id":"6ZpADbPBNBywL_QI-QsAP","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"train 1.9376758337020874\nval 2.026397943496704\n"},"children":[],"key":"VMKQPkCuJ5"}],"key":"I6mtw3raq5"}],"key":"FuccA8MAd5"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"code","lang":"python","value":"# original (3 character context + 200 hidden neurons, 12K params): train 2.058, val 2.105\n# context: 3 -> 8 (22K params): train 1.915, val 2.034\n# flat -> hierachical (22K params): train 1.937, val 2.026","position":{"start":{"line":1,"column":1},"end":{"line":5,"column":1}},"key":"x4sN0yBnCJ"}],"visibility":"show","key":"fgEIir4vrP"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"As you can see, changing from the flat to hierachical model (while keeping the same number of parameters) is not giving us any noticeable significant benefit in terms of the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TuNNkinKkG"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"loss","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nmS3GcwCsQ"}],"key":"FbACLrvQc6"},{"type":"text","value":".  That said, there are two things to point out. Number one, we didn’t really “torture” the architecture here very much. And there’s a bunch of hyperparameter search that we could do in terms of how we allocate our budget of parameters to what layers. Number two, we still may have a bug inside the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pt9Q2mZPOB"},{"type":"inlineCode","value":"BatchNorm1d","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BRfw9bteD1"},{"type":"text","value":" layer. So let’s take a look at that because it runs, but doesn’t do the right thing.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DdK8PP5hlX"}],"key":"UkpRkSlohh"}],"key":"U14pk33DpC"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Fixing the BatchNorm1d bug","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qYgWy63s42"}],"identifier":"fixing-the-batchnorm1d-bug","label":"Fixing the BatchNorm1d bug","html_id":"fixing-the-batchnorm1d-bug","implicit":true,"key":"y37PPhXSXU"}],"key":"Mp7YdiTUPx"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"If we train for just one step and we print the layer output shapes:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"b3O63yzZ3E"}],"key":"mK49YT1Vlf"}],"key":"FwS9F7ZDpu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"_ = train(xtrain, ytrain, model, parameters, break_at_step=1)\nmodel(xb)\nfor l in model.layers:\n    print(l.__class__.__name__, \":\", tuple(l.out.shape))","key":"QcVYpGRyuc"},{"type":"outputs","id":"Z6ZoZFgQ4mCRzQlwtNzY2","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"      0/ 200000: 2.0969\nEmbedding : (4, 8, 10)\nFlattenConsecutive : (4, 4, 20)\nLinear : (4, 4, 68)\nBatchNorm1d : (4, 4, 68)\nTanh : (4, 4, 68)\nFlattenConsecutive : (4, 2, 136)\nLinear : (4, 2, 68)\nBatchNorm1d : (4, 2, 68)\nTanh : (4, 2, 68)\nFlattenConsecutive : (4, 136)\nLinear : (4, 68)\nBatchNorm1d : (4, 68)\nTanh : (4, 68)\nLinear : (4, 27)\n"},"children":[],"key":"V7UWh6hBJy"}],"key":"KwS9uZmgee"}],"key":"tc6ZwI9S4X"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"currently, it looks like the BatchNorm is receiving an input that is ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GVoVh0p2Jp"},{"type":"inlineMath","value":"32\\times4\\times68","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>32</mn><mo>×</mo><mn>4</mn><mo>×</mo><mn>68</mn></mrow><annotation encoding=\"application/x-tex\">32\\times4\\times68</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">32</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">68</span></span></span></span>","key":"vNzaIDNtbp"},{"type":"text","value":", right? Let’s take a look at the implementation of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zGNhygEusL"},{"type":"inlineCode","value":"BatchNorm","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"R3jolXs7Q1"},{"type":"text","value":":","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"T1QzsvbNgI"}],"key":"JCsDntY5p0"},{"type":"code","lang":"python","value":"class BatchNorm1d:\n    def __init__(self, dim, eps=1e-5, momentum=0.1):\n        self.eps = eps\n        self.momentum = momentum\n        self.training = True\n        # parameters (trained with backprop)\n        self.gamma = torch.ones(dim)\n        self.beta = torch.zeros(dim)\n        # buffers (trained with a running 'momentum update')\n        self.running_mean = torch.zeros(dim)\n        self.running_var = torch.ones(dim)\n  \n    def __call__(self, x):\n        # calculate the forward pass\n        if self.training:\n            xmean = x.mean(0, keepdim=True) # batch mean\n            xvar = x.var(0, keepdim=True) # batch variance\n        else:\n            xmean = self.running_mean\n            xvar = self.running_var\n        xhat = (x - xmean) / torch.sqrt(xvar + self.eps) # normalize to unit variance\n        self.out = self.gamma * xhat + self.beta\n        # update the buffers\n        if self.training:\n            with torch.no_grad():\n                self.running_mean = (1 - self.momentum) * self.running_mean + self.momentum * xmean\n                self.running_var = (1 - self.momentum) * self.running_var + self.momentum * xvar\n        return self.out\n  \n    def parameters(self):\n        return [self.gamma, self.beta]","position":{"start":{"line":3,"column":1},"end":{"line":35,"column":1}},"key":"RckEiOg7m5"},{"type":"paragraph","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"children":[{"type":"text","value":"It assumed, in the way we wrote it and at the time, that the input ","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"nDiaqFrwd9"},{"type":"inlineCode","value":"x","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"k2C4pi1NcB"},{"type":"text","value":" is ","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"xWgXWUUzWf"},{"type":"inlineMath","value":"2D","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">2D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord\">2</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span>","key":"nicQc58Ox1"},{"type":"text","value":". So it was ","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"RFHUOZTsWC"},{"type":"inlineMath","value":"N \\times D","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi><mo>×</mo><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">N \\times D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span>","key":"iZLYHZTVWx"},{"type":"text","value":", where ","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"DR9zDwQ8xe"},{"type":"inlineMath","value":"N","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span>","key":"DkdW8ihIei"},{"type":"text","value":" was the batch size. So that’s why we only reduced the mean and the variance over the ","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"AVklgrkkeZ"},{"type":"inlineMath","value":"0th","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn><mi>t</mi><mi>h</mi></mrow><annotation encoding=\"application/x-tex\">0th</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord\">0</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span></span></span></span>","key":"GGTyOb5IQk"},{"type":"text","value":" dimension. But now ","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"h1fO0pWmEi"},{"type":"inlineCode","value":"x","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"uYTISpcR3Y"},{"type":"text","value":" will basically become ","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"XTyBuC4oX2"},{"type":"inlineMath","value":"3D","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>3</mn><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">3D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord\">3</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span>","key":"BXPVIFNGJF"},{"type":"text","value":". So what’s happening inside the ","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"rDJL7YkzAg"},{"type":"strong","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"children":[{"type":"text","value":"batchnorm","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"yfSMhhZdyy"}],"key":"GhPOPvM4u8"},{"type":"text","value":" layer right now? And how come it’s working at all and not giving any errors? The reason for that is basically because everything broadcasts properly, but the ","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"E6EROBlIde"},{"type":"strong","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"children":[{"type":"text","value":"batchnorm","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"fO84HXVf2E"}],"key":"cqOx9DZKVU"},{"type":"text","value":" is not doing what we want it to do. So in particular, let’s basically think through what’s happening inside the ","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"ZmX4QmqRlk"},{"type":"strong","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"children":[{"type":"text","value":"batchnorm","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"DMSlKuAU0S"}],"key":"auhgSkh1O5"},{"type":"text","value":". Let’s look at what’s happening here in a simplified example:","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"rRKhBp2UwK"}],"key":"s07jaHLal1"}],"key":"pcff6WXMPe"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"e = torch.randn(32, 4, 68)\nemean = e.mean(0, keepdim=True)  # 1, 4, 68\nevar = e.var(0, keepdim=True)  # 1, 4, 68\nehat = (e - emean) / torch.sqrt(evar + 1e-5)  # 32, 4, 68\nehat.shape","key":"hVmuthTdbM"},{"type":"outputs","id":"J8H82AVMZMSRXfzZQWNSb","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":84,"metadata":{},"data":{"text/plain":{"content":"torch.Size([32, 4, 68])","content_type":"text/plain"}}},"children":[],"key":"CXClBrVRFv"}],"key":"hSvoImtYLz"}],"key":"eLzwqagiRM"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"So we’re receiving an input of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yykgrnwT7F"},{"type":"inlineMath","value":"32\\times4\\times68","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>32</mn><mo>×</mo><mn>4</mn><mo>×</mo><mn>68</mn></mrow><annotation encoding=\"application/x-tex\">32\\times4\\times68</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">32</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">68</span></span></span></span>","key":"Zy02OGrxcJ"},{"type":"text","value":". And then we are doing here ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Y1qRm785dE"},{"type":"inlineCode","value":"x.mean()","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"q6HXR4hAsz"},{"type":"text","value":", but we have ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"daRKQHYo5J"},{"type":"inlineCode","value":"e","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SZbohQIHFL"},{"type":"text","value":" instead of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"h1tl3oDijQ"},{"type":"inlineCode","value":"x","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uMJ3xkmzG3"},{"type":"text","value":". But we’re doing the mean over ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fpIB3WkWAT"},{"type":"text","value":"0","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RVXEPEs18y"},{"type":"text","value":" and that’s actually giving us ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"EYbAfCjb5X"},{"type":"inlineMath","value":"1\\times4\\times68","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mo>×</mo><mn>4</mn><mo>×</mo><mn>68</mn></mrow><annotation encoding=\"application/x-tex\">1\\times4\\times68</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">68</span></span></span></span>","key":"SIKW2YsF82"},{"type":"text","value":". So we’re doing the mean only over the very first dimension. And it’s giving us a mean and a variance that still maintains the middle dimension in between (i.e. ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"B2ljsCJ8sQ"},{"type":"text","value":"4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BThi05MbLS"},{"type":"text","value":"). So these means are only taken over ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yfkw4uUumA"},{"type":"text","value":"32","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CJhLE86eul"},{"type":"text","value":" numbers in the first dimension. And then, when we perform the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oOZPRGlofu"},{"type":"inlineCode","value":"ehat","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LyGvAco3nc"},{"type":"text","value":" assignment, everything broadcasts correctly still. But basically what ends up happening is when we also look at the running mean:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OSGHYh9H1w"}],"key":"imqKdeX8ta"}],"key":"Q6Oju9W16E"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model.layers[3].running_mean.shape","key":"jFcptqKLSQ"},{"type":"outputs","id":"2Qepd5zCGq3Y--veLqUYW","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":85,"metadata":{},"data":{"text/plain":{"content":"torch.Size([1, 4, 68])","content_type":"text/plain"}}},"children":[],"key":"WxXk9CXwVa"}],"key":"A0DWZnrOyj"}],"key":"ptpBQFaNTE"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"the shape of this running mean now is ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kiPQAWn6Xo"},{"type":"inlineMath","value":"1\\times4\\times68","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mo>×</mo><mn>4</mn><mo>×</mo><mn>68</mn></mrow><annotation encoding=\"application/x-tex\">1\\times4\\times68</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">68</span></span></span></span>","key":"kSbcYoacMb"},{"type":"text","value":". Instead of it being just a size of dimension, because we have ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"b47eML2cZl"},{"type":"text","value":"68","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mH6yFutXO2"},{"type":"text","value":" channels, we expect to have ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"E24PrAqpj7"},{"type":"text","value":"68","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"as1xyDiUSW"},{"type":"text","value":" means and variances that we’re maintaining. But actually, we have an array of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"h1qoEKGbTV"},{"type":"inlineMath","value":"4\\times68","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>68</mn></mrow><annotation encoding=\"application/x-tex\">4\\times68</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">68</span></span></span></span>","key":"t6awpfoWpX"},{"type":"text","value":". And so basically what this is telling us is this ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Liku6hw0L6"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"batchnorm","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"wCCe1t7IWm"}],"key":"eohKJu0kaN"},{"type":"text","value":" is currently working in parallel over ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"v2YqCyD7Gq"},{"type":"inlineMath","value":"4\\times68","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mo>×</mo><mn>68</mn></mrow><annotation encoding=\"application/x-tex\">4\\times68</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">68</span></span></span></span>","key":"jnqgciCnyq"},{"type":"text","value":" instead of just ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Mu324qSPUk"},{"type":"text","value":"68","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jyycNuxZZ5"},{"type":"text","value":" channels. So basically we are maintaining this. We are maintaining statistics for every one of these four positions individually and independently. And instead, what we want to do is we want to treat this middle ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NIs146fU7V"},{"type":"text","value":"4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"baHSrELGcz"},{"type":"text","value":" dimension as a batch dimension, just like the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Wa7XRwtfKF"},{"type":"inlineMath","value":"0th","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn><mi>t</mi><mi>h</mi></mrow><annotation encoding=\"application/x-tex\">0th</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord\">0</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span></span></span></span>","key":"Nfytr3LRdt"},{"type":"text","value":" dimension. So as far as the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jvzcoX5dOx"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"batchnorm","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OMYgT5zXcy"}],"key":"hVbkMi3uag"},{"type":"text","value":" is concerned, it doesn’t want to average... We don’t want to average over ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FND4QQi9Z8"},{"type":"text","value":"32","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fKJm3wtPi7"},{"type":"text","value":" numbers. But instead, we want to now average over ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"b4RWxophc0"},{"type":"inlineMath","value":"32\\times4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>32</mn><mo>×</mo><mn>4</mn></mrow><annotation encoding=\"application/x-tex\">32\\times4</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">32</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">4</span></span></span></span>","key":"EP2B0lPc5p"},{"type":"text","value":" numbers for every single one of these ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PNje94o1m2"},{"type":"text","value":"68","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CViL02s7JX"},{"type":"text","value":" channels. Since ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Cevhq7Iwd6"},{"type":"link","url":"https://pytorch.org/docs/stable/generated/torch.mean.html","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"inlineCode","value":"torch.mean","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"A9lVIcAcDd"}],"urlSource":"https://pytorch.org/docs/stable/generated/torch.mean.html","key":"OjIuYLwbtL"},{"type":"text","value":" allows us to reduce over multiple (and not just one) dimensions at the same time, we’ll do just that and reduce over both the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"maIk0Lvdlb"},{"type":"inlineMath","value":"0th","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn><mi>t</mi><mi>h</mi></mrow><annotation encoding=\"application/x-tex\">0th</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord\">0</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span></span></span></span>","key":"PqxBifRkUI"},{"type":"text","value":" and ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"K3dSOvK8cl"},{"type":"inlineMath","value":"1st","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mi>s</mi><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">1st</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span></span></span></span>","key":"yGkLsgTjvX"},{"type":"text","value":" dimensions:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DtzRAiaJ5w"}],"key":"gqO93CN5Ma"}],"key":"G92bFf83FR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"e = torch.randn(32, 4, 68)\nemean = e.mean((0, 1), keepdim=True)  # 1, 1, 68\nevar = e.var((0, 1), keepdim=True)  # 1, 1, 68\nehat = (e - emean) / torch.sqrt(evar + 1e-5)  # 32, 4, 68\nehat.shape","key":"tAk9auFOLO"},{"type":"outputs","id":"f-PwOHR4id49RR_QF9snU","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":86,"metadata":{},"data":{"text/plain":{"content":"torch.Size([32, 4, 68])","content_type":"text/plain"}}},"children":[],"key":"lGDtovU62U"}],"key":"n7nHbxj9cH"}],"key":"JmOAGRuHfO"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Although the final shape of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"w8ZIn0jL20"},{"type":"inlineCode","value":"ehat","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Os6iS24qNy"},{"type":"text","value":" remains the same, we see now that:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uQNPlIgg8F"}],"key":"lEXGrEpQbS"}],"key":"wxmGjDbd2N"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"emean.shape, evar.shape","key":"LjCCPeP5JU"},{"type":"outputs","id":"5z8CX-8TdK_EDojXdT8zU","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":87,"metadata":{},"data":{"text/plain":{"content":"(torch.Size([1, 1, 68]), torch.Size([1, 1, 68]))","content_type":"text/plain"}}},"children":[],"key":"OqyRL8vtZn"}],"key":"gkMzap1d5X"}],"key":"T06PvKkyMm"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"instead of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lWsaPGXyDT"},{"type":"inlineCode","value":"1, 4, 68","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PKnFtEYbNs"},{"type":"text","value":", since we reduced over both of the batch dimensions, it yields only ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"v4egQYsnlS"},{"type":"text","value":"68","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rDw3IHmpN0"},{"type":"text","value":" numbers total for each tensor, with a bunch of spurious leftover ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dLAudiVlj7"},{"type":"text","value":"1","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OAk7RY16tK"},{"type":"text","value":" dimensions remaining. Therefore, this is what should be happening with our ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"wBL5iJeHcZ"},{"type":"inlineCode","value":"running_mean","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"m7BSCX78fd"},{"type":"text","value":" and ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"THQE8dmaw9"},{"type":"inlineCode","value":"running_var","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GnSc191EeU"},{"type":"text","value":" tensors inside our ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VzbOFcjJ5Z"},{"type":"inlineCode","value":"BatchNorm1d","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"x30iuJu2Kl"},{"type":"text","value":" implementation. So the change is pretty straightforward:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZSTvEZkqnq"}],"key":"qiO985rpYb"}],"key":"NjjYiWyI8r"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"class BatchNorm1d:\n    def __init__(self, dim, eps=1e-5, momentum=0.1):\n        self.eps = eps\n        self.momentum = momentum\n        self.training = True\n        # parameters (trained with backprop)\n        self.gamma = torch.ones(dim)\n        self.beta = torch.zeros(dim)\n        # buffers (trained with a running 'momentum update')\n        self.running_mean = torch.zeros(dim)\n        self.running_var = torch.ones(dim)\n\n    def __call__(self, x):\n        # calculate the forward pass\n        if self.training:\n            if x.ndim == 2:\n                dim = 0\n            elif x.ndim == 3:\n                dim = (0, 1)\n            xmean = x.mean(dim, keepdim=True)  # batch mean\n            xvar = x.var(dim, keepdim=True)  # batch variance\n        else:\n            xmean = self.running_mean\n            xvar = self.running_var\n        xhat = (x - xmean) / torch.sqrt(xvar + self.eps)  # normalize to unit variance\n        self.out = self.gamma * xhat + self.beta\n        # update the buffers\n        if self.training:\n            with torch.no_grad():\n                self.running_mean = (\n                    1 - self.momentum\n                ) * self.running_mean + self.momentum * xmean\n                self.running_var = (\n                    1 - self.momentum\n                ) * self.running_var + self.momentum * xvar\n        return self.out\n\n    def parameters(self):\n        return [self.gamma, self.beta]","key":"wJqGEH28y9"},{"type":"outputs","id":"QyNNndiTII8XHU9J9ks5y","children":[],"key":"M5VxDZdrHW"}],"key":"a286gdjuKz"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Basically, now in ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dZnPzJjYBO"},{"type":"inlineCode","value":"__call__","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Tq6whUB7lx"},{"type":"text","value":" we are checking the dimensionality of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DPU20UdYOG"},{"type":"inlineCode","value":"x","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"r7FehqWHRP"},{"type":"text","value":" and based on it we are determining the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Kw9ECuAEGY"},{"type":"inlineCode","value":"dim","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Mdb8hMo1GT"},{"type":"text","value":" parameters to be passed to the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SUNHqu7hzD"},{"type":"inlineCode","value":"mean","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IDl36EoXXy"},{"type":"text","value":" and ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"EtPqILIRPZ"},{"type":"inlineCode","value":"var","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hR5tssEemI"},{"type":"text","value":" functions. Now, to point out one more thing. We’re actually departing from the API of PyTorch here a little bit, because when you go read the documentation of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"R1xMXheGG9"},{"type":"link","url":"https://pytorch.org/docs/stable/generated/torch.nn.BatchNorm1d.html","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"inlineCode","value":"torch.nn.BatchNorm1d","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lOsSGap61R"}],"urlSource":"https://pytorch.org/docs/stable/generated/torch.nn.BatchNorm1d.html","key":"RTaity8r6t"},{"type":"text","value":", it says:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lu1LHhRBPe"}],"key":"vgn4RaPvgI"},{"type":"blockquote","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Input: ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ATHFUbfHwm"},{"type":"inlineMath","value":"(N,C)","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mi>N</mi><mo separator=\"true\">,</mo><mi>C</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(N,C)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mclose\">)</span></span></span></span>","key":"j114fq52KV"},{"type":"text","value":" or ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"PbA4eg5hxJ"},{"type":"inlineMath","value":"(N,C,L)","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mi>N</mi><mo separator=\"true\">,</mo><mi>C</mi><mo separator=\"true\">,</mo><mi>L</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">(N,C,L)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mclose\">)</span></span></span></span>","key":"zPvBwHs1vy"},{"type":"text","value":", where ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"uH7satMT9g"},{"type":"inlineMath","value":"N","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span>","key":"g8M6ZuOYyd"},{"type":"text","value":" is the batch size, ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"UF1HYphiQR"},{"type":"inlineMath","value":"C","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>C</mi></mrow><annotation encoding=\"application/x-tex\">C</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span></span>","key":"bPPGTZwA9N"},{"type":"text","value":" is the number of features or channels, and ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"W6lbQXqbAU"},{"type":"inlineMath","value":"L","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span>","key":"GQbsPa9H00"},{"type":"text","value":" is the sequence length","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"BiA8T1oI2P"}],"key":"gW027BDrVn"}],"key":"cNXdVBa1ti"}],"key":"IWkF7A3hDt"}],"key":"t2AaDgwPLu"}],"key":"eszkYPsayy"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Notice, the input to this layer can either be ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NtLB2rvy5v"},{"type":"inlineMath","value":"N","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi></mrow><annotation encoding=\"application/x-tex\">N</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span></span></span></span>","key":"ZyTTxT6tNQ"},{"type":"text","value":" (batch size) ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"C6tIGvBLLO"},{"type":"inlineMath","value":"\\times","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>×</mo></mrow><annotation encoding=\"application/x-tex\">\\times</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\"></span><span class=\"mord\">×</span></span></span></span>","key":"mrsQLXIsqQ"},{"type":"text","value":" ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dFkXxWSbtX"},{"type":"inlineMath","value":"C","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>C</mi></mrow><annotation encoding=\"application/x-tex\">C</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span></span>","key":"vEYfanuSRb"},{"type":"text","value":" (number of features or channels) or it actually does accept three-dimensional inputs, but it expects it to be ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sQCXfcYUaV"},{"type":"inlineMath","value":"N\\times C \\times L","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi><mo>×</mo><mi>C</mi><mo>×</mo><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">N\\times C \\times L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span>","key":"GedMVyCQbF"},{"type":"text","value":" (sequence legth). So this is a problem because you see how ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"u2vYjCMnCF"},{"type":"inlineMath","value":"C","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>C</mi></mrow><annotation encoding=\"application/x-tex\">C</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span></span>","key":"aI4r3TyPDm"},{"type":"text","value":" is nested here in the middle. And so when it gets ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"INc5kevMaC"},{"type":"inlineMath","value":"3D","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>3</mn><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">3D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord\">3</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span>","key":"mZkKI7Sq43"},{"type":"text","value":" inputs, this ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tTuerewEDn"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"batchnorm","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"q40jmdhhxV"}],"key":"FHoFo71jFF"},{"type":"text","value":" layer will reduce over ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Q37SnNknIy"},{"type":"inlineCode","value":"0","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"L3GAtQjxYB"},{"type":"text","value":" and ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xqMwIBF5u1"},{"type":"inlineCode","value":"2","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IW4uEoXquE"},{"type":"text","value":" instead of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MktMx98wwG"},{"type":"inlineCode","value":"0","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"E2QHg1l0JV"},{"type":"text","value":" and ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"K7KXXbKl2L"},{"type":"inlineCode","value":"1","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yG2MHlXqtI"},{"type":"text","value":". So basically, ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"g5p9MdarR9"},{"type":"link","url":"https://pytorch.org/docs/stable/generated/torch.nn.BatchNorm1d.html","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"inlineCode","value":"torch.nn.BatchNorm1d","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SdlgA6c0MK"}],"urlSource":"https://pytorch.org/docs/stable/generated/torch.nn.BatchNorm1d.html","key":"SBFUaBmwAN"},{"type":"text","value":" layer assumes that ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ANSZSMdEvH"},{"type":"inlineMath","value":"C","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>C</mi></mrow><annotation encoding=\"application/x-tex\">C</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span></span>","key":"Sj85fOhXbz"},{"type":"text","value":" will always be the first dimension, whereas we assume here that ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"G69hTvAQK1"},{"type":"inlineMath","value":"C","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>C</mi></mrow><annotation encoding=\"application/x-tex\">C</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span></span>","key":"LEKJhPKvqY"},{"type":"text","value":" is the last dimension, and there are some number of batch dimensions beforehand. And so, it expects ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"URlJBZNRjI"},{"type":"inlineMath","value":"N\\times C","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi><mo>×</mo><mi>C</mi></mrow><annotation encoding=\"application/x-tex\">N\\times C</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span></span>","key":"r7dSB1TwKJ"},{"type":"text","value":" or ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JfvKVKyypP"},{"type":"inlineMath","value":"N\\times C\\times L","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi><mo>×</mo><mi>C</mi><mo>×</mo><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">N\\times C\\times L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span>","key":"vAsDoTEkyh"},{"type":"text","value":", whereas we expect ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xah6wChgkc"},{"type":"inlineMath","value":"N\\times C","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi><mo>×</mo><mi>C</mi></mrow><annotation encoding=\"application/x-tex\">N\\times C</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span></span>","key":"TF2hZ6Ks9p"},{"type":"text","value":" or ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PxqDKDt3p7"},{"type":"inlineMath","value":"N\\times L\\times C","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi><mo>×</mo><mi>L</mi><mo>×</mo><mi>C</mi></mrow><annotation encoding=\"application/x-tex\">N\\times L\\times C</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span></span>","key":"eQG3tWLaVd"},{"type":"text","value":". So just a small deviation from the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Sdfv3KLite"},{"type":"inlineCode","value":"PyTorch","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Db0Cm7EvMW"},{"type":"text","value":" API. Now, after updating our ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FhFBDmWo0e"},{"type":"inlineCode","value":"BatchNorm1d","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HwBq2u5km5"},{"type":"text","value":", if we redefine our ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"meiJIzgj8z"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"k6Lvp09G0d"}],"key":"r7hjd9zr0Q"},{"type":"text","value":" and run for one step:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yC1ZMNGg4k"}],"key":"wP0B89sAPX"}],"key":"wDJAoeMDHA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model, parameters = define_nn(block_size, n_embd, n_hidden)\n_ = train(xtrain, ytrain, model, parameters, break_at_step=1)\nmodel(xb)\nfor l in model.layers:\n    print(l.__class__.__name__, \":\", tuple(l.out.shape))","key":"NNkMtsdOfE"},{"type":"outputs","id":"G9JetuTqQtaFDdj99w211","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"22397\n      0/ 200000: 3.2907\nEmbedding : (4, 8, 10)\nFlattenConsecutive : (4, 4, 20)\nLinear : (4, 4, 68)\nBatchNorm1d : (4, 4, 68)\nTanh : (4, 4, 68)\nFlattenConsecutive : (4, 2, 136)\nLinear : (4, 2, 68)\nBatchNorm1d : (4, 2, 68)\nTanh : (4, 2, 68)\nFlattenConsecutive : (4, 136)\nLinear : (4, 68)\nBatchNorm1d : (4, 68)\nTanh : (4, 68)\nLinear : (4, 27)\n"},"children":[],"key":"OR4IYpeI2n"}],"key":"ZH46NXQFJU"}],"key":"DG6aEhCSOh"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"the shapes are of course the same as before, but now if we inspect the shape of the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sCgtzq082D"},{"type":"inlineCode","value":"running_mean","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZlCO8aPW3y"},{"type":"text","value":" inside the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pjc55pWIWQ"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"batchnorm","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zVI0BYcJ6g"}],"key":"MBa11Wws3b"},{"type":"text","value":" layer:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ov23KOeKfN"}],"key":"gGGI2zhOD8"}],"key":"b1SpT8mieA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model.layers[3].running_mean.shape","key":"sZwJVLWMCk"},{"type":"outputs","id":"BtQd4AxskxRio6sDnyObI","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":90,"metadata":{},"data":{"text/plain":{"content":"torch.Size([1, 1, 68])","content_type":"text/plain"}}},"children":[],"key":"VTviYSyr5t"}],"key":"PPDDiRDKMo"}],"key":"DU0TkPWsGU"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"So correctly now we are only maintaining ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iMqXbxT8GF"},{"type":"text","value":"68","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cyo5X1OCLT"},{"type":"text","value":" means, for every one of our channels, and we are treating the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BZdkShcJtU"},{"type":"inlineMath","value":"0th","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn><mi>t</mi><mi>h</mi></mrow><annotation encoding=\"application/x-tex\">0th</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord\">0</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span></span></span></span>","key":"fsIQ5hIF5x"},{"type":"text","value":" and the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CNMqoM1YCx"},{"type":"inlineMath","value":"1st","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>1</mn><mi>s</mi><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">1st</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span></span></span></span>","key":"BWl7QoYHPM"},{"type":"text","value":" dimension as batch dimensions, which is exactly what we want!","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tMJIoLzshl"}],"key":"yXHKzoj0ko"}],"key":"JCQNUUU2iO"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Re-training the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RgU2BRfgDM"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"WaveNet","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iGf3E1Yfmk"}],"key":"ApscZSYexE"},{"type":"text","value":" after bug fix","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AL3wZ2vqsB"}],"identifier":"re-training-the-wavenet-after-bug-fix","label":"Re-training the WaveNet after bug fix","html_id":"re-training-the-wavenet-after-bug-fix","implicit":true,"key":"p2qL1GZ0jw"}],"key":"PLGR83tEX4"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"So let’s retrain the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YEjDaFVcD9"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ewh8Tcpby3"}],"key":"tuXc7BVdSH"},{"type":"text","value":" now, after the bug fix:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sVnN7ZHWvQ"}],"key":"AdgUNYzmrW"}],"key":"AQ8UQDEH9L"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model, parameters = define_nn(block_size, n_embd, n_hidden)\nlossi = train(xtrain, ytrain, model, parameters)","key":"qeHFeAdR39"},{"type":"outputs","id":"XfFscCZdfcLKAfaO631Uh","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"22397\n      0/ 200000: 3.3054\n  10000/ 200000: 2.2512\n  20000/ 200000: 2.3514\n  30000/ 200000: 2.5115\n  40000/ 200000: 1.6012\n  50000/ 200000: 2.1728\n  60000/ 200000: 1.8859\n  70000/ 200000: 2.1417\n  80000/ 200000: 2.0348\n  90000/ 200000: 1.7458\n 100000/ 200000: 1.7257\n 110000/ 200000: 1.9065\n 120000/ 200000: 2.0347\n 130000/ 200000: 2.1898\n 140000/ 200000: 2.2163\n 150000/ 200000: 1.7984\n 160000/ 200000: 1.4846\n 170000/ 200000: 1.7952\n 180000/ 200000: 2.0809\n 190000/ 200000: 2.2824\n"},"children":[],"key":"TMxPym8vyI"}],"key":"goEx5EX4ck"}],"key":"tZ6ceWH0sf"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"plt.figure()\nplt.plot(torch.tensor(lossi).view(-1, 1000).mean(1));","key":"J0C6gGfJK5"},{"type":"outputs","id":"osWnilQs3JvHLH0aJhmmd","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"089f12aea1ff4c02959e39af0a8a4ef2\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"image/png":{"content_type":"image/png","hash":"cdaf79a36040dbd960f88cb29bd58539","path":"/build/cdaf79a36040dbd960f88cb29bd58539.png"},"text/html":{"content_type":"text/html","hash":"a83b309522d993ec6ccf1704230ffdf5","path":"/build/a83b309522d993ec6ccf1704230ffdf5.html"},"text/plain":{"content":"Canvas(toolbar=Toolbar(toolitems=[('Home', 'Reset original view', 'home', 'home'), ('Back', 'Back to previous …","content_type":"text/plain"}}},"children":[],"key":"oehs5SAU53"}],"key":"WFPBMKP7fI"}],"key":"czHgXpBold"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"trigger_eval_mode(model)\ninfer_loss(model, xtrain, ytrain, prefix=\"train\")\ninfer_loss(model, xval, yval, prefix=\"val\");","key":"uITTCPyKcS"},{"type":"outputs","id":"jWr7ZwBe4yTSWdhQo2QZy","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"train 1.911558985710144\nval 2.019017219543457\n"},"children":[],"key":"IUCd8wm2tH"}],"key":"gk5nxzpttM"}],"key":"Xjs1IuB4Hp"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"And we can see that we are getting a tiny improvement in our training and validation losses:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fOi4EkCGse"}],"key":"I0hnX2JqdY"}],"key":"NsYyg2feo3"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"code","lang":"python","value":"# original (3 character context + 200 hidden neurons, 12K params): train 2.058, val 2.105\n# context: 3 -> 8 (22K params): train 1.915, val 2.034\n# flat -> hierachical (22K params): train 1.937, val 2.026\n# fix bug in batchnorm: train 1.911, val 2.019","position":{"start":{"line":1,"column":1},"end":{"line":6,"column":1}},"key":"rdlTbp2RbU"}],"visibility":"show","key":"zbNWcj8Y6C"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The reason this improvement is to be expected is that now we have less numbers going into the estimates of the mean and variance which allows everything to be more stable and less wiggly.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"r6IaRxbaee"}],"key":"ajq1ErbJ5r"}],"key":"XGcBr0skqO"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Scaling up our ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rVTpcS0NF5"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"WaveNet","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PplkrUGF61"}],"key":"qMOFY8lzr5"}],"identifier":"scaling-up-our-wavenet","label":"Scaling up our WaveNet","html_id":"scaling-up-our-wavenet","implicit":true,"key":"ZgRG86aoSu"}],"key":"brCHZzQReh"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"And with this more general architecture in place, we are now set up to push the performance further by increasing the size of the network:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AlMGropLOP"}],"key":"bxLLNHAH13"}],"key":"P9qFdeumid"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"n_embd = 24  # the dimensionality of the character embedding vectors\nn_hidden = 128  # the number of neurons in the hidden layer of the MLP","key":"vI8OZouGdn"},{"type":"outputs","id":"2pevTBxTuTaM7UVx-qtim","children":[],"key":"ovvijuRMHd"}],"key":"weQw1U2IbZ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"And using the exact same architecture, we now have","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kAzCGEYnzi"}],"key":"J0d7DEWeKu"}],"key":"M6QzxCxroN"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"model, parameters = define_nn(block_size, n_embd, n_hidden)","key":"l2t6SEBpY3"},{"type":"outputs","id":"xe2P2xmeFbMD2Gq27rbRZ","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"76579\n"},"children":[],"key":"XfaNF3wp79"}],"key":"dJ44gMNYF7"}],"key":"ukLpKzo8yq"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"76579","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MlagJ4qViz"},{"type":"text","value":" parameters and the training takes a lot longer:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jYwjGZAr0z"}],"key":"fLGGI4FfAK"}],"key":"NfjsXknAce"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"lossi = train(xtrain, ytrain, model, parameters)","key":"dwzYsFb5UI"},{"type":"outputs","id":"jX3b86XUZvaD0CFpPn5Uj","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"      0/ 200000: 3.3060\n  10000/ 200000: 2.1627\n  20000/ 200000: 1.8125\n  30000/ 200000: 2.1831\n  40000/ 200000: 1.9874\n  50000/ 200000: 2.3684\n  60000/ 200000: 2.1482\n  70000/ 200000: 1.7558\n  80000/ 200000: 1.8260\n  90000/ 200000: 1.8867\n 100000/ 200000: 1.9521\n 110000/ 200000: 1.9662\n 120000/ 200000: 1.9416\n 130000/ 200000: 2.0037\n 140000/ 200000: 1.9890\n 150000/ 200000: 1.7099\n 160000/ 200000: 1.8770\n 170000/ 200000: 1.5360\n 180000/ 200000: 1.4641\n 190000/ 200000: 1.8875\n"},"children":[],"key":"klPs94Mhrc"}],"key":"mrNiwRAw57"}],"key":"oiKUKzPnZe"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"but we do get a nice curve:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IE60c23cPr"}],"key":"LOOC3TZHKF"}],"key":"PJ2HIfUVE3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"plt.figure()\nplt.plot(torch.tensor(lossi).view(-1, 1000).mean(1));","key":"zNpxvWchRK"},{"type":"outputs","id":"7ndIk67PisUe1sZQUNVYv","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"application/vnd.jupyter.widget-view+json":{"content":"{\"model_id\":\"338ac53bc3b84c37828d28bf9e4e8ce7\",\"version_major\":2,\"version_minor\":0}","content_type":"application/vnd.jupyter.widget-view+json"},"image/png":{"content_type":"image/png","hash":"13aaa7d5b0f0198790fa6b2332620b23","path":"/build/13aaa7d5b0f0198790fa6b2332620b23.png"},"text/html":{"content_type":"text/html","hash":"99231f3c921b2f703abfc487ea65ae31","path":"/build/99231f3c921b2f703abfc487ea65ae31.html"},"text/plain":{"content":"Canvas(toolbar=Toolbar(toolitems=[('Home', 'Reset original view', 'home', 'home'), ('Back', 'Back to previous …","content_type":"text/plain"}}},"children":[],"key":"jN0nnBct8Q"}],"key":"JSYwWoNWaZ"}],"key":"qgK2xLOPyd"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"and we are now getting even better performance:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vqES6ZndMj"}],"key":"j6K1XnaHUI"}],"key":"xGFpbYHHdU"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"trigger_eval_mode(model)\ninfer_loss(model, xtrain, ytrain, prefix=\"train\")\ninfer_loss(model, xval, yval, prefix=\"val\");","key":"aJG0IrxTv4"},{"type":"outputs","id":"Sq_0tH1aB8FEJ6Ijr4pU9","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"train 1.7666022777557373\nval 1.9965752363204956\n"},"children":[],"key":"IWk3hlBEip"}],"key":"Qmz17t2VT1"}],"key":"nYPXhWbnr3"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"So, to compare to previous performances:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"b7DV5d67Mz"}],"key":"Ll9ph8TBLV"}],"key":"jguiMH4Kvy"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"code","lang":"python","value":"# original (3 character context + 200 hidden neurons, 12K params): train 2.058, val 2.105\n# context: 3 -> 8 (22K params): train 1.915, val 2.034\n# flat -> hierachical (22K params): train 1.937, val 2.026\n# fix bug in batchnorm: train 1.911, val 2.019\n# scale up the network: n_embd 24, n_hidden 128 (76K params): train 1.768, val 1.990","position":{"start":{"line":1,"column":1},"end":{"line":7,"column":1}},"key":"DjDcRaR2gQ"}],"visibility":"show","key":"pWuZ3j9NpA"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"However because the experiments are starting to take longer to train, we are a little bit in the dark with respect to the correct setting of the hyperparameters here and the learning rates and so on. And so we are missing sort of like an experimental harness on which we could run a number of experiments and really tune this architecture very well.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HXcaxouBbg"}],"key":"eKWbUhyhmq"}],"key":"DmCNFIGRWd"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"WaveNet but with dilated causal convolutions","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BrdRIf7aNW"}],"identifier":"wavenet-but-with-dilated-causal-convolutions","label":"WaveNet but with dilated causal convolutions","html_id":"wavenet-but-with-dilated-causal-convolutions","implicit":true,"key":"FAW9JmFhno"}],"key":"DjokCORVr4"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"So let’s conclude now with a few notes. We basically improved our performance noticeably from a val ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"W1xCWVuxBh"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"loss","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UsPufrFiOO"}],"key":"s0IZgJx8Zp"},{"type":"text","value":" of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gTItWXWXeC"},{"type":"text","value":"2.10","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Sb8jt8eClk"},{"type":"text","value":" to ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"syHdllFvaE"},{"type":"text","value":"1.99","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BuTI2M70gB"},{"type":"text","value":". But this shouldn’t be the focus as we are kind of in the dark. We have no experimental harness, we are just guessing and checking. And this whole thing is pretty terrible to be honest. We are just looking at the training ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gxma4R0VOP"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"loss","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Uzp684nm4l"}],"key":"iWmN2W6Lvj"},{"type":"text","value":", whereas we should be looking at the training and validation ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VdvM7swpX5"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"loss","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vXfej8y9F5"}],"key":"dXkZXzUXIk"},{"type":"text","value":" together. That said, we did implement the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KW9fU2n4vy"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"WaveNet","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ySvMQJzoJt"}],"key":"eJMPHAzS02"},{"type":"text","value":" architecture from the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nJARqE7nzH"},{"type":"link","url":"https://arxiv.org/abs/1609.03499","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"paper","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IPBBP7k9Y7"}],"urlSource":"https://arxiv.org/abs/1609.03499","key":"KMoZsPcgPX"},{"type":"text","value":":","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"eYzZdOizwU"}],"key":"CpTzk3k8g7"}],"key":"DONXpTAed7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from IPython.display import Image, display\n\ndisplay(Image(filename=\"wavenet_fig3.png\"))","key":"OGKG1dXjUn"},{"type":"outputs","id":"KZ-zLYBliOLAX32-HsxP3","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"198c39366ff68e8b03ccb06df349f47a","path":"/build/198c39366ff68e8b03ccb06df349f47a.png"},"text/plain":{"content":"<IPython.core.display.Image object>","content_type":"text/plain"}}},"children":[],"key":"DFZGPeB69u"}],"key":"yyn8t8pBnd"}],"key":"dQbOawuyW0"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"But we did not implement this specific forward pass of it:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WVFZp4eVCh"}],"key":"wu4QLVDmeT"}],"key":"q5i3vt52VB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from IPython.display import Image, display\n\ndisplay(Image(filename=\"wavenet_fig4.png\"))","key":"xPjndYXqse"},{"type":"outputs","id":"6qGczBaMyZIpAdOQSbLmq","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"54272b3d206b11fb693990a90d767eee","path":"/build/54272b3d206b11fb693990a90d767eee.png"},"text/plain":{"content":"<IPython.core.display.Image object>","content_type":"text/plain"}}},"children":[],"key":"lVtoS08V7x"}],"key":"PnfTAisv9z"}],"key":"iw4wpcVrwO"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"where you have a more complicated kind of gated linear layer with residual connections, skip connections and so on... So we did not implement this, but only the tree-like model. All things considered, let’s briefly go over how what we’ve done here relates to convolutional neural networks as used in the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LCHLOec43t"},{"type":"link","url":"https://arxiv.org/abs/1609.03499","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"WaveNet paper","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UMzHwFDtEd"}],"urlSource":"https://arxiv.org/abs/1609.03499","key":"t7rjHwsaGa"},{"type":"text","value":". Basically the use of convolutions is strictly for efficiency. It doesn’t actually change the model we’ve implemented. So, here for example:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"u3qt2uckKR"}],"key":"A9dPbWcr0Z"}],"key":"x5JDZEgjjR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print_next_character(xtrain[46:54], ytrain[46:54])","key":"OoalOXSOVL"},{"type":"outputs","id":"GOW381S9jEDwc9gXnrPo6","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"........ --> a\n.......a --> n\n......an --> a\n.....ana --> l\n....anal --> i\n...anali --> s\n..analis --> a\n.analisa --> .\n"},"children":[],"key":"Qk8s8EuEOj"}],"key":"T0fLu2qFpI"}],"key":"bnNlKtRiME"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"we see the name ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KutxWWDheU"},{"type":"inlineCode","value":"analisa","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"W3U4dvHeBr"},{"type":"text","value":" from our training set and it has ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FYEz3OeI1x"},{"type":"text","value":"7","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"wHiqgqPg5v"},{"type":"text","value":" letters, so that is ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vCd8jEKWjg"},{"type":"text","value":"8","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"wXViC4CKDs"},{"type":"text","value":" rows which correspond to independent examples of that name. Now, we can forward any one of these rows independently:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"L0gurj4UDl"}],"key":"L7cYqQLHZM"}],"key":"NA0ToXfhXv"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# forward a single example\nsingle_example = xtrain[[7]]  # index by [[7]] to get an extra batch dimension\nlogits = model(single_example)\nlogits.shape","key":"JvVyx3GqKy"},{"type":"outputs","id":"PqbTjrd7Sii2WV3freVqT","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":102,"metadata":{},"data":{"text/plain":{"content":"torch.Size([1, 27])","content_type":"text/plain"}}},"children":[],"key":"j5KVQMYvb7"}],"key":"vfdLnetNRN"}],"key":"b02VCZoKsb"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now imagine that instead of just a single example, you would like to forward all of the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"EZc468wfAv"},{"type":"text","value":"8","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xWbZf5jgsP"},{"type":"text","value":" examples that make up the name into the network at the same time:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LELOtkO9Ne"}],"key":"wB7XlyNG5y"}],"key":"hlObQ1VnpF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# forward all of them\nlogits = torch.zeros(8, 27)\nfor i in range(7):\n    logits[i] = model(xtrain[[7 + i]])\nlogits.shape","key":"BPNFhJsgrz"},{"type":"outputs","id":"pjPzkTVRENAmTLdapmKFO","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":103,"metadata":{},"data":{"text/plain":{"content":"torch.Size([8, 27])","content_type":"text/plain"}}},"children":[],"key":"VdlOp4oRTb"}],"key":"PDeB9rqj81"}],"key":"PtO9YOs3ZG"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Of course, as we’ve implemented this right now, this is ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"QyVVQbaqdL"},{"type":"text","value":"8","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GGRrYTjdnE"},{"type":"text","value":" independent calls to our model. But what convolutions allow you to do is they allow you to “slide” this model efficiently over the input sequence. And so this for loop we just wrote out can be done not “outside”, through iteration, in Python, but “inside” of kernels in ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zMXrTyrIRC"},{"type":"link","url":"https://en.wikipedia.org/wiki/CUDA","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"inlineCode","value":"CUDA","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VAu5Qqk8Ff"}],"urlSource":"https://en.wikipedia.org/wiki/CUDA","data":{"page":"CUDA","wiki":"https://en.wikipedia.org/","lang":"en"},"internal":false,"protocol":"wiki","key":"apzVyznSpA"},{"type":"text","value":". And so this for loop gets hidden into the convolution. So basically you can think of the convolution as a for loop applying a little linear filter over space of some input sequence. And in our case the space we’re interested in is one dimensional. And we are interested in sliding these filter over the input data. This diagram is quite helpful for understanding actually:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fGd839uG4N"}],"key":"jR4rSoJqpl"}],"key":"FXjjOTndl9"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from IPython.display import Image, display\n\ndisplay(Image(filename=\"wavenet_fig3.png\"))","key":"jRdA1hgZhB"},{"type":"outputs","id":"X7uGNl-ZzHGO2vSpqUu86","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"198c39366ff68e8b03ccb06df349f47a","path":"/build/198c39366ff68e8b03ccb06df349f47a.png"},"text/plain":{"content":"<IPython.core.display.Image object>","content_type":"text/plain"}}},"children":[],"key":"zs3kaoEs14"}],"key":"BjZyg2aXuu"}],"key":"YSPBPn67MU"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Here, you can see highlighted with black arrows a single tree of the calculation we just described. So depicted here, calculating a single orange node at the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Y3hF2zevy0"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Output","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RRfqsMWox9"}],"key":"pcMrc4d7kr"},{"type":"text","value":" layer corresponds to us in our example forwarding a single example and getting out a single output. But what convolutions allow you to do is it allows you to take this black tree-like structure and kind of like slide it over the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ixEiLtjGbE"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Input","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ek1uPfMpgw"}],"key":"W9PzNStU7f"},{"type":"text","value":" sequence (blue nodes) and calculate all of the orange outputs at the same time. In the above figure, this sliding action is represented by the dashed connections between the nodes. In our example:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vC6v8o6D0E"}],"key":"JxjnTR2rrX"}],"key":"Tbj0oDxndj"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"print_next_character(xtrain[46:54], ytrain[46:54])","key":"qyaRfk6nOK"},{"type":"outputs","id":"oI_GBXYa1vafOiseC_ONd","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"........ --> a\n.......a --> n\n......an --> a\n.....ana --> l\n....anal --> i\n...anali --> s\n..analis --> a\n.analisa --> .\n"},"children":[],"key":"QZnGziivre"}],"key":"dXw6R76GhU"}],"key":"wOqvPOvf94"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"this sliding operation would correspond to calculating all the above ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"u3CXo7QABD"},{"type":"text","value":"8","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ss6FM9Mb9s"},{"type":"text","value":" outputs at all the positions of the name (like we did in an explicit loop) at the same time. And the reason this is much more efficient is because the for loop is inside the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VYQwKYL0YD"},{"type":"inlineCode","value":"CUDA","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ESMX6exgPZ"},{"type":"text","value":" kernels. That makes it efficient. Also, notice the node re-use in the diagram were for example in the first ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"H35ruU46RH"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Hidden Layer","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YVGzk15FDx"}],"key":"miJZ4ISYo3"},{"type":"text","value":" each white node is the right child of the white node above it (in the second ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XEhIpSR05g"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Hidden Layer","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DXA4TgQ3gH"}],"key":"dmUY2gcyvK"},{"type":"text","value":"), but also the left child of another white node (also in the second ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YXkQsj7KlV"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Hidden Layer","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zjSEimJ7oT"}],"key":"nDDxJF9dxX"},{"type":"text","value":"). In the first ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AK35Gh3qm5"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Hidden Layer","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vloK5oUJjj"}],"key":"ICNPAwNZYb"},{"type":"text","value":", each node and its value is used twice. Therefore, in our above example snippet, with our naive way we would have to recalculate the value that corresponds to such a node, whereas with such a convolutional ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jPe5LCc5Ir"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VDI2ls0kYb"}],"key":"aWNTVGTxtu"},{"type":"text","value":" we are allowed to reuse it. So, in the convolutional ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HtbQYHm8xM"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SCN6Hz4YkZ"}],"key":"LnA7QAadkI"},{"type":"text","value":" you can think of the linear layer as filters. And we take these filters and their linear filters and we slide them over the input sequence and we calculate the first layer, the second layer, the third layer and then the output layer of the sandwich and it is all done very efficiently using these convolutions.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UTAMX00SB8"}],"key":"KK79OB3Wok"}],"key":"rJbWhUTS3w"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Summary","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"H4rTfVxRuB"}],"identifier":"summary","label":"Summary","html_id":"summary","implicit":true,"key":"APd40MuChb"}],"key":"JNmiDDPtwN"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Another thing to take away from this lecture is having modeled our ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Qg7VxinFYd"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WTbBwoLKG8"}],"key":"GqnYByY9NQ"},{"type":"text","value":" lego blocks: the module classes (","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PN1AMiDJkB"},{"type":"inlineCode","value":"Linear","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TrSEuQGfCu"},{"type":"text","value":", etc.) after modules from ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HGi2qgcxb3"},{"type":"link","url":"https://pytorch.org/docs/stable/nn.html","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"inlineCode","value":"torch.nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TNYbAXQxzf"}],"urlSource":"https://pytorch.org/docs/stable/nn.html","key":"Zmi9ySNNWd"},{"type":"text","value":". So it is now very easy to start using modules directly from PyTorch, from hereon. The next thing I hope you got a bit of a sense of is what the development process of building deep neural networks looks like. Which I think was relatively representative to some extent. So number one, we are spending a lot of time in the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JjoQE5x87j"},{"type":"link","url":"https://pytorch.org/docs/stable/nn.html","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"documentation page of PyTorch","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"D5AhJUl7V7"}],"urlSource":"https://pytorch.org/docs/stable/nn.html","key":"LXeT22PvTi"},{"type":"text","value":". And we’re reading through all the layers, looking at documentations, what are the shapes of the inputs, what they can be, what does the layer do, and so on. Unfortunately, however, the PyTorch documentation is not very good, at least not at the time these lectures were implemented. The PyTorch developers spend a ton of time on hardcore engineering of all kinds of distributed primitives, etc. But no one is rigorously maintaining documentation. It will lie to you, it will be wrong, it will be incomplete, it will be unclear. So unfortunately, it is what it is and you just kind of have to do your best with what they give us. Also, there’s a ton of trying to make the shapes work. And there’s a lot of gymnastics around these multi-dimensional arrays. Are they ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"A4QrJ1uIuv"},{"type":"inlineMath","value":"2D","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>2</mn><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">2D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord\">2</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span>","key":"MxkFsSeU9V"},{"type":"text","value":", ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WYFjyUeWrF"},{"type":"inlineMath","value":"3D","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>3</mn><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">3D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord\">3</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span>","key":"xLbuqiayKX"},{"type":"text","value":", ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"b8ZdFXrYVa"},{"type":"inlineMath","value":"4D","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mi>D</mi></mrow><annotation encoding=\"application/x-tex\">4D</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord\">4</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span></span></span></span>","key":"BK0qnfLXaA"},{"type":"text","value":"? What shapes do the layers take? Is it ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"E4L3q0A9pw"},{"type":"inlineMath","value":"N\\times C\\times L","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi><mo>×</mo><mi>C</mi><mo>×</mo><mi>L</mi></mrow><annotation encoding=\"application/x-tex\">N\\times C\\times L</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">L</span></span></span></span>","key":"j7KjZvCW80"},{"type":"text","value":" or ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mzLvWOxS9K"},{"type":"inlineMath","value":"N\\times L\\times C","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>N</mi><mo>×</mo><mi>L</mi><mo>×</mo><mi>C</mi></mrow><annotation encoding=\"application/x-tex\">N\\times L\\times C</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\">L</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span></span></span></span>","key":"wKS2t6jnJ9"},{"type":"text","value":"? And you’re permuting and viewing, and it just gets pretty messy. And so that brings me to number three. It’s often helpful to first prototype these layers and implementations in jupyter notebooks and make sure that all the shapes work out, initially making sure everything is correct. And then, once you’re satisfied with the functionality, you can copy-paste the code into your actual code base or repository (e.g. in VSCode). So these are roughly only some notes on the development process of working with ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"O0RdvI3h4a"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TJ3x37GvIa"}],"key":"OhqnC4qtgQ"},{"type":"text","value":"s.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xk0pzYHvt9"}],"key":"oxUQRJ4JfD"}],"key":"KbN0iqCa9V"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Outro","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"A0e1bm2cDh"}],"identifier":"outro","label":"Outro","html_id":"outro","implicit":true,"key":"SrMCObmtLD"}],"key":"aXnjTLgtBi"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Lastly, this lecture unlocks a lot of potential further lectures because, number one, we have to convert our ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"StmRQc1pVQ"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"nn","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"x5JZWpgdc1"}],"key":"mpNyjQU6O0"},{"type":"text","value":" to actually use these dilated causal convolutional layers, so implementing the convnet. Number two, we potentially start to get into what this means, where are residual connections and skip connections and why are they useful. Number three, as we already mentioned, we don’t have any experimental harness. So right now, we are just guessing and checking everything. This is not representative of typical deep learning workflows. You usually have to set up your evaluation harness. You have lots of arguments that your script can take. You’re more comfortably kicking off a lot of experiments. You’re looking at a lot of plots of training and validation losses, and you’re looking at what is working and what is not working. And you’re working on this like population level, and you’re doing all these hyperparameter searches. So we’ve done none of that so far. So how to set that up and how to make it good, I think is a whole other topic. And number four, we should probably cover RNNs, LSTMs, GRUs, and of course Transformers. So many places to go, and we’ll cover that in the future. That’s all for now. Bye! :)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XKsfxiXxdU"}],"key":"W8nHqQEUMZ"}],"key":"tCt3MYCNKt"}],"key":"M15fNFq1mh"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"5. makemore (part 4): becoming a backprop ninja","url":"/micrograduate/makemore4","group":"microgra∇uate"},"next":{"title":"7. picoGPT: implementing a tiny GPT from scratch","url":"/micrograduate/picogpt","group":"microgra∇uate"}}},"domain":"http://localhost:3000"}